# –û—Ç—á—ë—Ç: –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)

**–î–∞—Ç–∞:** 2025-02-16

---

## 1. –ì–¥–µ —É–¥–∞–ª—ë–Ω –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ ingest –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

**–§–∞–π–ª:** `modern_scheduler.py`  
**–ú–µ—Ç–æ–¥:** `ModernEventScheduler.start()`

**–ë—ã–ª–æ:** –ø–æ—Å–ª–µ `self.scheduler.start()` –∏ –≤—ã–≤–æ–¥–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–¥–∞—á –≤—ã–∑—ã–≤–∞–ª—Å—è:
```python
self.run_full_ingest()
```
–∏–∑‚Äë–∑–∞ —á–µ–≥–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ/—Ä–µ—Å—Ç–∞—Ä—Ç–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø–∞—Ä—Å–∏–Ω–≥–∞ (BaliForum + AI) –∏ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–ª–æ—Å—å `üöÄ === –ù–ê–ß–ê–õ–û –¶–ò–ö–õ–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–û–ë–´–¢–ò–ô ===`.

**–°—Ç–∞–ª–æ:** —ç—Ç–æ—Ç –≤—ã–∑–æ–≤ —É–¥–∞–ª—ë–Ω. Ingest –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ cron (2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å –¥–ª—è BaliForum+AI –∏ –¥–ª—è KudaGo) –∏–ª–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É (—Å—Ç–∞—Ä—ã–π `POST /admin/ingest/run` –¥–ª—è ICS).

---

## 2. –ì–¥–µ –¥–æ–±–∞–≤–ª–µ–Ω auto-backfill

**–§–∞–π–ª:** `modern_scheduler.py`  
**–ú–µ—Ç–æ–¥:** `ModernEventScheduler.start()`

**–ú–µ—Å—Ç–æ:** —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `self.scheduler.start()` –∏ –±–ª–æ–∫–∞ —Å –≤—ã–≤–æ–¥–æ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á, **–≤–º–µ—Å—Ç–æ** —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ `run_full_ingest()`.

**–õ–æ–≥–∏–∫–∞:**
1. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å:
   ```sql
   SELECT COUNT(*) FROM events
   WHERE title_en IS NULL AND title IS NOT NULL AND TRIM(COALESCE(title, '')) != ''
   ```
2. –ï—Å–ª–∏ `count > 0`:
   - –ª–æ–≥: `[AUTO-BACKFILL] Found X events without EN`
   - –ª–æ–≥: `[AUTO-BACKFILL] Starting backfill...`
   - –≤—ã–∑–æ–≤ `run_backfill()` –∏–∑ `utils.backfill_translation`
   - –ª–æ–≥: `[AUTO-BACKFILL] Completed. translated=Y`
3. –ï—Å–ª–∏ `count == 0`: –ª–æ–≥ —É—Ä–æ–≤–Ω—è debug: `[AUTO-BACKFILL] No events without EN, skip`

Backfill –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (–≤ –ø–æ—Ç–æ–∫–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞), –Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º webhook –∏ –Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

## 3. –ì–¥–µ –¥–æ–±–∞–≤–ª–µ–Ω batch –¥–ª—è KudaGo –∏ AI

### KudaGo

**–§–∞–π–ª:** `modern_scheduler.py`  
**–ú–µ—Ç–æ–¥:** `ingest_kudago()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –°–Ω–∞—á–∞–ª–∞ –ø–æ –≤—Å–µ–º –≥–æ—Ä–æ–¥–∞–º (moscow, spb) —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ —Å–ø–∏—Å–æ–∫ `prepared` —Å –ø–æ–ª—è–º–∏ `external_id`, `title`, `event`.
- –ü–æ –≤—Å–µ–º `external_id` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—ã–±–æ—Ä–∫–∞ –∏–∑ –ë–î: —É –∫–æ–≥–æ —É–∂–µ –µ—Å—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π `title_en`.
- –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ `to_translate`: —Å–æ–±—ã—Ç–∏—è –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞ –∏ —Å –Ω–µ–ø—É—Å—Ç—ã–º `title`.
- –ï—Å–ª–∏ `to_translate` –Ω–µ –ø—É—Å—Ç: –ª–æ–≥ `[INGEST] Missing translations (KudaGo): X`, –≤—ã–∑–æ–≤ `translate_titles_batch(titles)`, –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ `title_en_map` –ø–æ `external_id`.
- –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –≤ `save_parser_event` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è `title_en=title_en_map.get(ext_id)` (–¥–ª—è —É–∂–µ –ø–µ—Ä–µ–≤–µ–¥—ë–Ω–Ω—ã—Ö –≤ –ë–î –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è `None`, –∏ –≤–Ω—É—Ç—Ä–∏ `save_parser_event` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ –ë–î).

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –¥–ª—è KudaGo –¥–µ–ª–∞–µ—Ç—Å—è **–æ–¥–∏–Ω batch-–∑–∞–ø—Ä–æ—Å –∫ GPT** –Ω–∞ –≤—Å–µ –Ω–æ–≤—ã–µ/–±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤–º–µ—Å—Ç–æ –¥–µ—Å—è—Ç–∫–æ–≤ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö.

### AI

**–§–∞–π–ª:** `modern_scheduler.py`  
**–ú–µ—Ç–æ–¥:** `ingest_ai_events()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:** —Ç–∞ –∂–µ —Å—Ö–µ–º–∞:
- –°–±–æ—Ä –≤—Å–µ—Ö AI-—Å–æ–±—ã—Ç–∏–π –ø–æ –≤—Å–µ–º —Ç–æ—á–∫–∞–º –ë–∞–ª–∏ –≤ `prepared` (—Å `external_id`, `title`, `starts_at`, `event`).
- –í—ã–±–æ—Ä–∫–∞ –∏–∑ –ë–î –ø–æ `source = 'ai'` –¥–ª—è —É–∂–µ –ø–µ—Ä–µ–≤–µ–¥—ë–Ω–Ω—ã—Ö.
- –°–ø–∏—Å–æ–∫ `to_translate`, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî `translate_titles_batch`, `title_en_map`.
- –õ–æ–≥ `[INGEST] Missing translations (AI): X` –∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–µ—Ä–µ–¥–∞—á–∞ `title_en=title_en_map.get(ext_id)` –≤ `save_parser_event`.

–ò—Ç–æ–≥: **–æ–¥–∏–Ω batch –Ω–∞ –≤–µ—Å—å AI-ingest** –≤–º–µ—Å—Ç–æ –≤—ã–∑–æ–≤–∞ GPT –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ.

---

## 4. –ó–∞—â–∏—Ç–Ω—ã–π –ª–æ–≥ –≤ save_parser_event

**–§–∞–π–ª:** `utils/unified_events_service.py`  
**–ú–µ—Ç–æ–¥:** `save_parser_event()`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:** –≤ –≤–µ—Ç–∫–µ, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–µ—Ä–µ–≤–æ–¥ (–Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è GPT):
```python
elif existing_row and existing_has_title_en:
    logger.debug("[TRANSLATION-SKIP] Using existing EN for external_id=%s", external_id)
    title_en = existing_row[3]
    ...
```

–ü—Ä–∏ —É—Ä–æ–≤–Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è DEBUG –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ, —á—Ç–æ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ `external_id` –ø–µ—Ä–µ–≤–æ–¥ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ.

---

## 5. –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

### –°—Ç–∞—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ ingest)

```
üöÄ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω!
   üìÖ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤ (2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å)
   üå¥ BaliForum (–ë–∞–ª–∏) + üé≠ KudaGo (–ú–æ—Å–∫–≤–∞, –°–ü–±)
   ...
[AUTO-BACKFILL] Found 31 events without EN
[AUTO-BACKFILL] Starting backfill...
[BACKFILL] Found 25 events without EN
[BACKFILL] Batch translated 25
[BACKFILL] Found 6 events without EN
[BACKFILL] Batch translated 6
[BACKFILL] Completed. processed=31 translated=31 skipped=0
[AUTO-BACKFILL] Completed. translated=31
üîî –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞...
```

–ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–π –±–µ–∑ EN –Ω–µ—Ç:
```
[AUTO-BACKFILL] No events without EN, skip
```

### Cron ingest (BaliForum)

```
üöÄ –ó–ê–ü–£–°–ö –ü–õ–ê–ù–û–í–û–ì–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø –î–ê–ù–ù–´–•
üå¥ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ BaliForum...
[INGEST] Missing translations: 5
   üìù –ü–∞–∫–µ—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥: 5/5 –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
   ‚úÖ BaliForum: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ=...
```

### Cron ingest (KudaGo)

```
üöÄ –ó–ê–ü–£–°–ö –ü–õ–ê–ù–û–í–û–ì–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø –î–ê–ù–ù–´–• (KudaGo)
   üåç –ü–∞—Ä—Å–∏–º moscow...
   üåç –ü–∞—Ä—Å–∏–º spb...
[INGEST] Missing translations (KudaGo): 12
   üìù KudaGo –ø–∞–∫–µ—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥: 12/12 –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
   ‚úÖ KudaGo: –≤—Å–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ=...
```

### Cron ingest (AI)

```
ü§ñ –ó–∞–ø—É—Å–∫ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π...
[INGEST] Missing translations (AI): 8
   üìù AI –ø–∞–∫–µ—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥: 8/8 –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
   ‚úÖ AI: —Å–æ–∑–¥–∞–Ω–æ=...
```

### –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (DEBUG)

```
[TRANSLATION-SKIP] Using existing EN for external_id=12345
```

---

## 6. –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –Ω–µ—Ç –ø–æ–ª–Ω–æ–≥–æ ingest (–Ω–µ—Ç –ª–æ–≥–∞ ¬´–ù–ê–ß–ê–õ–û –¶–ò–ö–õ–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø¬ª) | ‚úÖ |
| –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ: –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–±—ã—Ç–∏—è –±–µ–∑ EN ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è AUTO-BACKFILL | ‚úÖ |
| –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π –±–µ–∑ EN ‚Üí backfill –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è | ‚úÖ |
| –ü—Ä–∏ cron: BaliForum ‚Äî batch | ‚úÖ |
| –ü—Ä–∏ cron: KudaGo ‚Äî batch | ‚úÖ |
| –ü—Ä–∏ cron: AI ‚Äî batch | ‚úÖ |
| –ü—Ä–∏ –ø–æ–∫–∞–∑–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: GPT –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –∏–∑ –ë–î | ‚úÖ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) |
| GPT –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–ª—è —É–∂–µ –ø–µ—Ä–µ–≤–µ–¥—ë–Ω–Ω—ã—Ö (–µ—Å—Ç—å –ª–æ–≥ SKIP) | ‚úÖ |

---

## 7. –†—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

- –ó–∞–ø—É—Å–∫–∞—Ç—å backfill –≤—Ä—É—á–Ω—É—é –Ω–µ –Ω—É–∂–Ω–æ: –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ–Ω –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –µ—Å–ª–∏ –≤ –ë–î –µ—Å—Ç—å —Å–æ–±—ã—Ç–∏—è —Å –ø—É—Å—Ç—ã–º `title_en`.
- –†—É—á–Ω–æ–π –≤—ã–∑–æ–≤ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –¥–æ—Å—Ç—É–ø–µ–Ω: `POST /admin/translation/backfill` –¥–ª—è —Ä–∞–∑–æ–≤—ã—Ö –¥–æ–≥–æ–Ω—è—é—â–∏—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
