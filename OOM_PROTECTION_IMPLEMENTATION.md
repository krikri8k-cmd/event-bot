# üõ°Ô∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞—â–∏—Ç—ã –æ—Ç OOM –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. Memory Guard (–∂—ë—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è RAM —á–µ—Ä–µ–∑ `psutil`
- ‚úÖ –ü–æ—Ä–æ–≥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏: **512 –ú–ë**
- ‚úÖ –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:
  - –£–¥–∞–ª—è–µ—Ç—Å—è 50% —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏–∑ `user_state`
  - –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç—Å—è `prepared_events` –¥–æ 25 (–≤–º–µ—Å—Ç–æ 50)
  - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–∏—Å—Ç–∫–∏

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `log_memory_stats()`:
  - –†–∞–∑–º–µ—Ä `user_state`
  - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ `prepared_events`
  - –¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ **5 –º–∏–Ω—É—Ç**
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ `_processed_callbacks`
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –≤ `DuplicateCallbackMiddleware`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∞–ª–≥–æ—Ä–∏—Ç–º –æ—á–∏—Å—Ç–∫–∏ (in-place)

### 4. –ì–∞—Ä–∞–Ω—Ç–∏–∏ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ–≤–µ–¥—ë–Ω –∞—É–¥–∏—Ç –∫–æ–¥–∞:
  - –í—Å–µ —Å–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ PostgreSQL **—Å—Ä–∞–∑—É** —á–µ—Ä–µ–∑:
    - `events_service.create_user_event()` - –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
    - `community_service.create_community_event()` - –¥–ª—è —Å–æ–±—ã—Ç–∏–π —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
  - `user_state` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –¥–ª—è:
    - UI/–Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (`map_message_id`, `list_message_id`)
    - –í—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (`prepared`, `counts`, `page`, `radius`)
  - –ü–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π: **1) PostgreSQL, 2) user_state**

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è callback-–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: –≤ `user_state` —Ö—Ä–∞–Ω—è—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—ã–µ —Ç–∏–ø—ã**:
  - `dict`, `list`, `int`, `str`, `float`
- ‚úÖ **–ó–∞–ø—Ä–µ—â–µ–Ω–æ** —Ö—Ä–∞–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏, –∑–∞–º—ã–∫–∞–Ω–∏—è, –æ–±—ä–µ–∫—Ç—ã —Å –º–µ—Ç–æ–¥–∞–º–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥

### 6. –û—á–∏—Å—Ç–∫–∞ –±–µ–∑ –∞–ª–ª–æ–∫–∞—Ü–∏–π
- ‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç **in-place**
- ‚úÖ –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ `_processed_callbacks`

## üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞—â–∏—Ç—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| `USER_STATE_MAX_SIZE` | 500 | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–∞–º—è—Ç–∏ |
| `USER_STATE_TTL_SECONDS` | 1800 (30 –º–∏–Ω) | –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è |
| `MAX_PREPARED_EVENTS` | 50 | –ú–∞–∫—Å–∏–º—É–º —Å–æ–±—ã—Ç–∏–π –≤ prepared (–ø—Ä–∏ Memory Guard: 25) |
| `MEMORY_THRESHOLD_MB` | 512 | –ü–æ—Ä–æ–≥ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ |
| –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ | 15 –º–∏–Ω—É—Ç | –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ | 5 –º–∏–Ω—É—Ç | –ò–Ω—Ç–µ—Ä–≤–∞–ª –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ |

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤ –∫–æ–¥–µ)

```
PostgreSQL = Source of Truth (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)
user_state = –í—Ä–µ–º–µ–Ω–Ω—ã–π –∫—ç—à (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–∏—â–µ–Ω –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç)

–ü–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π:
1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ user_state (—Ç–æ–ª—å–∫–æ –¥–ª—è UI/–Ω–∞–≤–∏–≥–∞—Ü–∏–∏)

–í user_state —Ö—Ä–∞–Ω—è—Ç—Å—è –¢–û–õ–¨–ö–û:
- –ü—Ä–æ—Å—Ç—ã–µ —Ç–∏–ø—ã: dict, list, int, str, float
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: message_id, prepared events, pagination state

–ó–ê–ü–†–ï–©–ï–ù–û:
- –§—É–Ω–∫—Ü–∏–∏, –∑–∞–º—ã–∫–∞–Ω–∏—è, –æ–±—ä–µ–∫—Ç—ã —Å –º–µ—Ç–æ–¥–∞–º–∏
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ PostgreSQL
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
```
üìä MEMORY STATS: user_state=123, prepared_events=456, memory=234.5MB
```

–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞:
```
‚ö†Ô∏è MEMORY GUARD: –ü–∞–º—è—Ç—å –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –ø–æ—Ä–æ–≥ (600.0MB > 512MB), –≤—ã–ø–æ–ª–Ω—è—é –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É
üßπ MEMORY GUARD: –£–¥–∞–ª–µ–Ω–æ 250 –∑–∞–ø–∏—Å–µ–π –∏–∑ user_state
‚úÖ MEMORY GUARD: –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–∞–º—è—Ç—å: 450.0MB (–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ 150.0MB)
```

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `requirements.txt`:
- `psutil>=5.9.0` - –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–º—è—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –±–µ–∑ –Ω–µ–≥–æ)

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ OOM
- ‚úÖ Cursor –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–æ–µ–∫—Ç–∞
- ‚úÖ –ü–∞–º—è—Ç—å –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–±—ã—Ç–∏—è –≤ PostgreSQL –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—â–∏—â–µ–Ω—ã
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å —à–∞–≥ –∑–∞–Ω–æ–≤–æ, **–±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö**

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞—Å—Ç–∏:
- –í—ã–Ω–µ—Å—Ç–∏ `user_state` –≤ Redis / KeyDB —Å TTL
- –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM –ø—Ä–æ—Ü–µ—Å—Å–∞
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus/Grafana
