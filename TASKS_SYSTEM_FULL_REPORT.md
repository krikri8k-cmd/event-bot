# üìã –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç: –°–∏—Å—Ç–µ–º–∞ –∑–∞–¥–∞–Ω–∏–π (–ö–≤–µ—Å—Ç—ã)

## üéØ –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

**–¢–∞–±–ª–∏—Ü—ã:**
1. **`tasks`** - –®–∞–±–ª–æ–Ω—ã –∑–∞–¥–∞–Ω–∏–π (legacy, –¥–ª—è fallback)
   - `id`, `category`, `title`, `description`, `task_type` (urban/island), `location_url`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –º–µ—Å—Ç –±–µ–∑ GPT-–ø–æ–¥—Å–∫–∞–∑–æ–∫

2. **`task_places`** - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ —Å GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
   - `id`, `name`, `category`, `task_type`, `task_hint` (GPT-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ), `google_maps_url`, `lat`, `lng`, `region`
   - –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–¥–∞–Ω–∏–π

3. **`user_tasks`** - –ü—Ä–∏–Ω—è—Ç—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∑–∞–¥–∞–Ω–∏—è
   - `id`, `user_id`, `task_id` (nullable!), `place_id`, `status`
   - **Frozen –ø–æ–ª—è** (–∫–ª—é—á–µ–≤—ã–µ!): `frozen_title`, `frozen_description`, `frozen_task_hint`, `frozen_category`
   - `place_name`, `place_url`, `promo_code`
   - `accepted_at`, `expires_at` (10 –ª–µ—Ç, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–Ω—è—Ç–æ)

### –ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø: "Frozen –¥–∞–Ω–Ω—ã–µ"

**–ü—Ä–∞–≤–∏–ª–æ:** –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–¥–∞–Ω–∏–µ, –≤—Å–µ –¥–∞–Ω–Ω—ã–µ "–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—é—Ç—Å—è" –≤ `frozen_*` –ø–æ–ª—è—Ö.
- –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ –∂–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∏–¥–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `frozen_*` - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è UI
- `tasks` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è XP/–Ω–∞–≥—Ä–∞–¥/–∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –ù–ï –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

---

## üîÑ –°—Ü–µ–Ω–∞—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑ –º–µ—Å—Ç–∞ (–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–µ—Å—Ç–∞)

**–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞:** `create_task_from_place(user_id, place_id)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:**
   ```
   –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å —Ç–∞–∫–∏–º place_id?
   –ï—Å–ª–∏ –¥–∞ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É "–ö–≤–µ—Å—Ç —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω"
   ```

2. **–ò–µ—Ä–∞—Ä—Ö–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏):**
   
   **1. GPT Hint (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):**
   ```
   –ï—Å–ª–∏ place.task_hint —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
     - task_id = NULL (GPT-–∑–∞–¥–∞–Ω–∏–µ, –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ —à–∞–±–ª–æ–Ω—É)
     - frozen_title = place.task_hint
     - frozen_description = place.task_hint
     - frozen_task_hint = place.task_hint
     - frozen_category = place.category
   ```

   **2. –®–∞–±–ª–æ–Ω (fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –º–µ—Å—Ç):**
   ```
   –ï—Å–ª–∏ place.task_hint –ù–ï–¢:
     - –ò—â–µ–º task –ø–æ: category == place.category AND task_type == place.task_type
     - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí –∏—â–µ–º task –ø–æ: category == place.category (–ª—é–±–æ–π —Ç–∏–ø)
     - –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω:
       - task_id = task.id
       - frozen_title = task.title
       - frozen_description = task.description
       - frozen_task_hint = NULL
       - frozen_category = place.category
   ```

   **3. Default (–µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç):**
   ```
   –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ GPT, –Ω–∏ —à–∞–±–ª–æ–Ω–∞:
     - task_id = NULL
     - frozen_title = "–ü–æ—Å–µ—Ç–∏ {place.name}"
     - frozen_description = "–ü–æ—Å–µ—Ç–∏ —ç—Ç–æ –º–µ—Å—Ç–æ –∏ —Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ"
     - frozen_task_hint = NULL
     - frozen_category = place.category
   ```

3. **–°–æ–∑–¥–∞–Ω–∏–µ UserTask:**
   ```
   user_task = UserTask(
     user_id=user_id,
     task_id=task_id_for_db,  # NULL –¥–ª—è GPT, ID –¥–ª—è fallback
     place_id=place.id,
     place_name=place.name,
     place_url=place.google_maps_url,
     promo_code=place.promo_code,
     frozen_title=frozen_title,
     frozen_description=frozen_description,
     frozen_task_hint=frozen_task_hint,
     frozen_category=frozen_category,
     status="active",
     expires_at=accepted_at + 10 –ª–µ—Ç
   )
   ```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ task_id (legacy)

**–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞:** `accept_task(user_id, task_id)`

**–ü—Ä–æ—Ü–µ—Å—Å:**
```
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º: task —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∞–∫—Ç–∏–≤–µ–Ω?
2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã: –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å —Ç–∞–∫–∏–º task_id –∏ place_id = NULL?
3. –°–æ–∑–¥–∞–µ–º UserTask:
   - task_id = task_id
   - place_id = NULL (–Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–µ—Å—Ç–∞)
   - frozen_* = –ù–ï –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è (—Å—Ç–∞—Ä–æ–µ –∑–∞–¥–∞–Ω–∏–µ)
   - expires_at = accepted_at + 10 –ª–µ—Ç
```

**–í–∞–∂–Ω–æ:** –≠—Ç–æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ, –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞–Ω–∏–π –±–µ–∑ –º–µ—Å—Ç.

---

## üì∫ –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π

### –†–∞–∑–¥–µ–ª 1: "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–µ—Å—Ç–∞"

**–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞:** `show_tasks_for_category(category)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Å—Ç:**
   ```
   all_places = get_all_places_for_category(
     category=category,
     user_lat=user_lat,
     user_lng=user_lng,
     task_type=region_type  # urban –∏–ª–∏ island
   )
   ```

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
   ```
   –ò—Å–∫–ª—é—á–∞–µ–º –º–µ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ UserTask —Å place_id = place.id –∏ status = 'active'?
   - –ï—Å–ª–∏ –¥–∞ ‚Üí –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ç–æ –º–µ—Å—Ç–æ
   ```

3. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**
   ```
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º:
   - –ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞
   - task_hint (GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∞) –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ
   - –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –º–µ—Å—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
   - –ö–Ω–æ–ø–∫–∞ "üéØ –ó–∞–±—Ä–∞—Ç—å –∫–≤–µ—Å—Ç"
   ```

### –†–∞–∑–¥–µ–ª 2: "–ú–æ–∏ –∫–≤–µ—Å—Ç—ã"

**–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞:** `get_user_active_tasks(user_id)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π:**
   ```
   user_tasks = SELECT UserTask LEFT JOIN Task
   WHERE user_id = user_id AND status = 'active'
   ```
   **–í–∞–∂–Ω–æ:** LEFT JOIN, —Ç–∞–∫ –∫–∞–∫ task_id –º–æ–∂–µ—Ç –±—ã—Ç—å NULL

2. **–ò–µ—Ä–∞—Ä—Ö–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏):**

   **1. Frozen –¥–∞–Ω–Ω—ã–µ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):**
   ```
   –ï—Å–ª–∏ user_task.frozen_title –∏ user_task.frozen_description —Å—É—â–µ—Å—Ç–≤—É—é—Ç:
     - title = user_task.frozen_title
     - description = user_task.frozen_description
     - category = user_task.frozen_category OR task.category (fallback)
     - task_hint = user_task.frozen_task_hint
   ```

   **2. –®–∞–±–ª–æ–Ω (fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞–Ω–∏–π):**
   ```
   –ï—Å–ª–∏ frozen –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –Ω–æ task —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
     - title = task.title
     - description = task.description
     - category = task.category
     - task_hint = NULL
   ```

   **3. Default (–µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç):**
   ```
   –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ frozen, –Ω–∏ task:
     - title = user_task.place_name OR "–ó–∞–¥–∞–Ω–∏–µ"
     - description = "–ü–æ—Å–µ—Ç–∏ {place_name} –∏ —Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ"
     - category = user_task.frozen_category
   ```

3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Å—Ç–µ:**

   **–ü–†–ò–û–†–ò–¢–ï–¢ 1: place_id (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π):**
   ```
   –ï—Å–ª–∏ user_task.place_id —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
     - –ó–∞–≥—Ä—É–∂–∞–µ–º TaskPlace –∏–∑ –ë–î
     - place_name = TaskPlace.name
     - place_url = TaskPlace.google_maps_url
     - promo_code = TaskPlace.promo_code
     - –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   ```

   **–ü–†–ò–û–†–ò–¢–ï–¢ 2: place_name –∏ place_url (—Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ):**
   ```
   –ï—Å–ª–∏ place_id –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å place_name –∏ place_url:
     - –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ UserTask –Ω–∞–ø—Ä—è–º—É—é
   ```

   **–ü–†–ò–û–†–ò–¢–ï–¢ 3: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ (legacy, –¥–ª—è –∑–∞–¥–∞–Ω–∏–π –±–µ–∑ –º–µ—Å—Ç–∞):**
   ```
   –ï—Å–ª–∏ –Ω–µ—Ç –º–µ—Å—Ç–∞, –Ω–æ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
     - –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–≥–∏–æ–Ω: get_user_region(lat, lng)
     - –ï—Å–ª–∏ —Ä–µ–≥–∏–æ–Ω = "unknown":
       ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å Google Maps
     - –ï—Å–ª–∏ —Ä–µ–≥–∏–æ–Ω –∏–∑–≤–µ—Å—Ç–µ–Ω (moscow, spb, bali, jakarta):
       ‚Üí –ò—â–µ–º –±–ª–∏–∂–∞–π—à–µ–µ –º–µ—Å—Ç–æ —á–µ—Ä–µ–∑ find_nearest_available_place()
   ```

4. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**
   ```
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º:
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–∏–∑ frozen –∏–ª–∏ task)
   - –û–ø–∏—Å–∞–Ω–∏–µ (–∏–∑ frozen –∏–ª–∏ task)
   - –ú–µ—Å—Ç–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –ü—Ä–æ–º–æ–∫–æ–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   ```

### –†–∞–∑–¥–µ–ª 3: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏"

**–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞:** `handle_task_manage(callback)`

**–ü—Ä–æ—Ü–µ—Å—Å:**
```
1. –ü–æ–ª—É—á–∞–µ–º UserTask –ø–æ ID
2. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ –∏ –≤ "–ú–æ–∏ –∫–≤–µ—Å—Ç—ã"
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é + –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```

---

## üó∫Ô∏è –õ–æ–≥–∏–∫–∞ –≤—ã–¥–∞—á–∏ –ª–æ–∫–∞—Ü–∏–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

### –§—É–Ω–∫—Ü–∏—è: `get_all_places_for_category()`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `category`: "food", "health", "places"
- `user_lat`, `user_lng`: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `task_type`: "urban" –∏–ª–∏ "island" (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —Ä–µ–≥–∏–æ–Ω—É)

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞:**
   ```
   region = get_user_region(lat, lng)
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: "moscow", "spb", "bali", "jakarta", "unknown"
   ```

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–µ—Å—Ç:**
   ```
   –ó–∞–ø—Ä–æ—Å:
   SELECT * FROM task_places
   WHERE category = :category
     AND task_type = :task_type
     AND region = :region
     AND is_active = TRUE
   ```

3. **–†–æ—Ç–∞—Ü–∏—è (–∏–∑–±–µ–∂–∞–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–æ–≤):**
   ```
   –ò—Å–∫–ª—é—á–∞–µ–º –º–µ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è:
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É daily_views_tasks
   - –ï—Å–ª–∏ –º–µ—Å—Ç–æ –±—ã–ª–æ –ø–æ–∫–∞–∑–∞–Ω–æ < 3 –¥–Ω–µ–π –Ω–∞–∑–∞–¥ ‚Üí –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
   ```

4. **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è:**
   ```
   –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ:
   1. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–º–µ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å > 7 –¥–Ω–µ–π)
   2. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   3. ID (–¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
   ```

5. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:**
   ```
   –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º N –º–µ—Å—Ç (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
   ```

### –°—Ü–µ–Ω–∞—Ä–∏–π: –†–µ–≥–∏–æ–Ω "unknown"

**–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ –∏–∑–≤–µ—Å—Ç–Ω–æ–º —Ä–µ–≥–∏–æ–Ω–µ:**

1. **–î–ª—è –∑–∞–¥–∞–Ω–∏–π —Å –º–µ—Å—Ç–æ–º:**
   ```
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Å—Ç–∞ –∏–∑ task_places —Å region = NULL –∏–ª–∏ "unknown"
   - –ï—Å–ª–∏ –Ω–µ—Ç –º–µ—Å—Ç ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å Google Maps
   ```

2. **–î–ª—è –∑–∞–¥–∞–Ω–∏–π –±–µ–∑ –º–µ—Å—Ç–∞ (legacy):**
   ```
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ:
     * category (food/health/places)
     * task_type (urban/island)
     * –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   
   –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:
   - "cafe near me" (food, urban)
   - "gym near me" (health, urban)
   - "park near me" (places, urban)
   - "beach near me" (places, island)
   ```

---

## üîç Edge Cases –∏ –û—Å–æ–±—ã–µ –°—Ü–µ–Ω–∞—Ä–∏–∏

### 1. –ó–∞–¥–∞–Ω–∏–µ –±–µ–∑ –º–µ—Å—Ç–∞ (legacy)

**–°–∏—Ç—É–∞—Ü–∏—è:** `UserTask.place_id = NULL`

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º frozen –¥–∞–Ω–Ω—ã–µ
2. –ï—Å–ª–∏ –Ω–µ—Ç frozen ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º task (fallback)
3. –ï—Å–ª–∏ –Ω–µ—Ç task ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º default —Ç–µ–∫—Å—Ç
4. –î–ª—è –ª–æ–∫–∞—Ü–∏–∏:
   - –ï—Å–ª–∏ task.location_url —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
```

### 2. –ú–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –ë–î

**–°–∏—Ç—É–∞—Ü–∏—è:** `UserTask.place_id` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ `TaskPlace` –Ω–µ –Ω–∞–π–¥–µ–Ω

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```
1. –û—á–∏—â–∞–µ–º place_id, place_name, place_url –≤ UserTask
2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ –±–µ–∑ –º–µ—Å—Ç–∞
3. –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
```

### 3. –ù–µ—Ç GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–∞

**–°–∏—Ç—É–∞—Ü–∏—è:** `place.task_hint = NULL` –∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ `task`

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```
–ò—Å–ø–æ–ª—å–∑—É–µ–º default —Ç–µ–∫—Å—Ç:
- frozen_title = "–ü–æ—Å–µ—Ç–∏ {place.name}"
- frozen_description = "–ü–æ—Å–µ—Ç–∏ —ç—Ç–æ –º–µ—Å—Ç–æ –∏ —Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ"
- task_id = NULL
```

### 4. –°—Ç–∞—Ä–æ–µ –∑–∞–¥–∞–Ω–∏–µ –±–µ–∑ frozen –¥–∞–Ω–Ω—ã—Ö

**–°–∏—Ç—É–∞—Ü–∏—è:** `UserTask` —Å–æ–∑–¥–∞–Ω –¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏ 035

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º frozen –¥–∞–Ω–Ω—ã–µ
2. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º task (fallback)
3. –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
4. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞–Ω–∏–π
```

### 5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–º —Ä–µ–≥–∏–æ–Ω–µ

**–°–∏—Ç—É–∞—Ü–∏—è:** `get_user_region()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "unknown"

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```
1. –î–ª—è –º–µ—Å—Ç: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Å—Ç–∞ —Å region = NULL –∏–ª–∏ "unknown"
2. –î–ª—è –∑–∞–¥–∞–Ω–∏–π –±–µ–∑ –º–µ—Å—Ç–∞: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å Google Maps
3. –ù–µ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–µ–µ –º–µ—Å—Ç–æ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–≥–∏–æ–Ω–µ)
```

### 6. –ó–∞–¥–∞–Ω–∏–µ —Å task_id = NULL (GPT-–∑–∞–¥–∞–Ω–∏–µ)

**–°–∏—Ç—É–∞—Ü–∏—è:** GPT-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```
1. LEFT JOIN —Å Task ‚Üí task = None
2. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ frozen –¥–∞–Ω–Ω—ã–µ
3. –ù–µ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ task
```

---

## üìä –ò–µ—Ä–∞—Ä—Ö–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö (–ò—Ç–æ–≥–æ–≤–∞—è)

### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è:

```
1. GPT Hint (place.task_hint) ‚Üí task_id = NULL, frozen = task_hint
2. –®–∞–±–ª–æ–Ω (task) ‚Üí task_id = task.id, frozen = task
3. Default ‚Üí task_id = NULL, frozen = default —Ç–µ–∫—Å—Ç
```

### –ü—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è:

```
1. Frozen –¥–∞–Ω–Ω—ã–µ (user_task.frozen_*) ‚Üí –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
2. –®–∞–±–ª–æ–Ω (task) ‚Üí fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞–Ω–∏–π
3. Default ‚Üí –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç
```

### –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª–æ–∫–∞—Ü–∏–∏:

```
1. place_id ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ–º TaskPlace –∏–∑ –ë–î
2. place_name + place_url ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ UserTask
3. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ ‚Üí –¥–ª—è –∑–∞–¥–∞–Ω–∏–π –±–µ–∑ –º–µ—Å—Ç–∞ (legacy)
```

---

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞

### 1. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –º–µ—Å—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —É –º–µ—Å—Ç–∞ –Ω–µ—Ç `task_hint` –∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —à–∞–±–ª–æ–Ω–∞ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è default —Ç–µ–∫—Å—Ç

**–†–µ—à–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `task_hint` –¥–ª—è –≤—Å–µ—Ö –º–µ—Å—Ç —á–µ—Ä–µ–∑ GPT

### 2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –º–µ—Å—Ç–∞ (legacy)

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è –∑–∞–¥–∞–Ω–∏–π –±–µ–∑ `place_id` —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –º–µ—Å—Ç–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ –Ω–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è —Å `place_id`

### 3. –°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è –±–µ–∑ frozen –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è –º–æ–≥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞–Ω–∏–π

### 4. –†–µ–≥–∏–æ–Ω "unknown"

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–µ—Å—Ç

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–∞ —Å `region = NULL` –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞

### 5. –†–æ—Ç–∞—Ü–∏—è –º–µ—Å—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –≤—Å–µ –º–µ—Å—Ç–∞ ‚Üí —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å?

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ 7 –¥–Ω–µ–π –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ—Å—Ç–∞ —Å–Ω–æ–≤–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è)

---

## ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

1. **Frozen –¥–∞–Ω–Ω—ã–µ** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
2. **Nullable task_id** - –≥–∏–±–∫–æ—Å—Ç—å –¥–ª—è GPT-–∑–∞–¥–∞–Ω–∏–π
3. **–ò–µ—Ä–∞—Ä—Ö–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤** - –ø–æ–Ω—è—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ fallback
4. **–†–æ—Ç–∞—Ü–∏—è –º–µ—Å—Ç** - –∏–∑–±–µ–∂–∞–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–æ–≤
5. **–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞** - —Ä–∞–∑–Ω—ã–µ –º–µ—Å—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

1. **–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å task_hint –¥–ª—è –≤—Å–µ—Ö –º–µ—Å—Ç** - —É–±—Ä–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —à–∞–±–ª–æ–Ω–æ–≤
2. **–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è** - –∑–∞–ø–æ–ª–Ω–∏—Ç—å frozen –¥–∞–Ω–Ω—ã–µ
3. **–£–ª—É—á—à–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞** - –º–µ–Ω—å—à–µ "unknown"
4. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–∞ –¥–ª—è unknown —Ä–µ–≥–∏–æ–Ω–æ–≤** - –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å –ø–æ–∏—Å–∫
5. **–£–±—Ä–∞—Ç—å legacy –ª–æ–≥–∏–∫—É** - –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å place_id

---

## üìù SQL –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```sql
-- GPT-–∑–∞–¥–∞–Ω–∏—è (task_id = NULL)
SELECT COUNT(*) FROM user_tasks WHERE task_id IS NULL AND status = 'active';

-- –ó–∞–¥–∞–Ω–∏—è —Å —à–∞–±–ª–æ–Ω–∞–º–∏ (task_id != NULL)
SELECT COUNT(*) FROM user_tasks WHERE task_id IS NOT NULL AND status = 'active';

-- –ó–∞–¥–∞–Ω–∏—è –±–µ–∑ frozen –¥–∞–Ω–Ω—ã—Ö
SELECT COUNT(*) FROM user_tasks 
WHERE status = 'active' 
AND (frozen_title IS NULL OR frozen_description IS NULL);

-- –ó–∞–¥–∞–Ω–∏—è –±–µ–∑ –º–µ—Å—Ç–∞
SELECT COUNT(*) FROM user_tasks WHERE place_id IS NULL AND status = 'active';

-- –ú–µ—Å—Ç–∞ –±–µ–∑ GPT-–ø–æ–¥—Å–∫–∞–∑–æ–∫
SELECT COUNT(*) FROM task_places WHERE task_hint IS NULL AND is_active = TRUE;
```

