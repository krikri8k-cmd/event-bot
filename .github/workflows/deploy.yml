name: ðŸš€ Deploy Event-Bot with Automation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ§¹ Lint with ruff
      run: |
        pip install ruff
        ruff check .
        ruff format --check .
        
    - name: ðŸ§ª Test imports
      run: |
        python -c "
        try:
            from modern_scheduler import ModernEventScheduler
            from start_production import main
            from sources.baliforum import fetch
            from utils.unified_events_service import UnifiedEventsService
            print('âœ… All imports successful')
        except Exception as e:
            print(f'âŒ Import error: {e}')
            exit(1)
        "
        
    - name: ðŸŽ¯ Set environment variables
      run: |
        echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
        echo "TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}" >> $GITHUB_ENV
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        echo "MOMENTS_ENABLE=0" >> $GITHUB_ENV
        echo "AI_PARSE_ENABLE=1" >> $GITHUB_ENV
        echo "ENABLE_BALIFORUM=1" >> $GITHUB_ENV
        echo "ENABLE_KUDAGO=1" >> $GITHUB_ENV
        
        # Debug: Check if DATABASE_URL is set
        echo "ðŸ” Debug: Checking environment variables..."
        if [ -n "$DATABASE_URL" ]; then
          echo "âœ… DATABASE_URL is set (length: ${#DATABASE_URL})"
        else
          echo "âŒ DATABASE_URL is NOT set"
        fi
        
    - name: ðŸŽ¯ Validate configuration
      run: |
        python -c "
        from config import load_settings
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ÑÑ
        try:
            settings = load_settings()
            print('âœ… Configuration loaded successfully')
            print(f'   BaliForum enabled: {settings.enable_baliforum}')
            print(f'   KudaGo enabled: {settings.kudago_enabled}')
            print(f'   AI parsing enabled: {settings.ai_parse_enable}')
            print(f'   Moments enabled: {settings.moments_enable}')
            print('   (Using GitHub Secrets)')
        except Exception as e:
            print(f'âŒ Config error: {e}')
            exit(1)
        "
        
    - name: ðŸ—„ï¸ Check database connection
      run: |
        python -c "
        from database import engine
        from config import load_settings
        
        print('ðŸ—„ï¸ Checking database connection...')
        try:
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ
            with engine.connect() as conn:
                result = conn.execute('SELECT 1')
                print('âœ… Database connection successful')
                
                # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹
                result = conn.execute(\"SELECT table_name FROM information_schema.tables WHERE table_schema = 'public'\")
                tables = [row[0] for row in result]
                print(f'ðŸ“Š Found {len(tables)} tables: {tables[:5]}...')
                
        except Exception as e:
            print(f'âŒ Database connection error: {e}')
            exit(1)
        "
        
    - name: ðŸ“Š Show deployment info
      run: |
        echo "ðŸŽ‰ === DEPLOYMENT READY ==="
        echo "ðŸ“‹ What will be deployed:"
        echo "   ðŸ¤– Telegram Bot"
        echo "   ðŸš€ Automation Scheduler (every 12 hours)"
        echo "   ðŸ§¹ Auto-cleanup (every 6 hours)"
        echo "   ðŸ“Š Correct architecture (events_parser â†’ events)"
        echo ""
        echo "â° Automation schedule:"
        echo "   ðŸŒ… Morning parsing (~08:00)"
        echo "   ðŸŒ™ Evening parsing (~20:00)"
        echo ""
        echo "âœ… Code is ready for production deployment!"
        
    - name: ðŸ·ï¸ Create release tag
      if: github.ref == 'refs/heads/main'
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÐ³ Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Ð¼ÐµÑ‚ÐºÐ¾Ð¹
        TAG="v$(date +%Y%m%d-%H%M%S)-automation"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a $TAG -m "ðŸš€ Production deployment with automation system"
        echo "Created tag: $TAG"
        
    - name: ðŸ“ Generate deployment summary
      run: |
        echo "# ðŸŽ¯ Event-Bot Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âœ… Successfully Deployed Features:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¤– **Telegram Bot** - User interaction" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸš€ **Automation System** - Every 12 hours parsing" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§¹ **Auto-cleanup** - Every 6 hours" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š **Correct Architecture** - events_parser â†’ events" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ´ **BaliForum Parser** - Real events from baliforum.ru" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¤– **AI Parser** - Smart event generation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Deploy to your hosting platform (Railway, Heroku, etc.)" >> $GITHUB_STEP_SUMMARY
        echo "2. Set environment variables" >> $GITHUB_STEP_SUMMARY
        echo "3. Run: \`python start_production.py\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“š Documentation:" >> $GITHUB_STEP_SUMMARY
        echo "- [Deployment Guide](./DEPLOY_WITH_AUTOMATION.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [Modern Scheduler](./modern_scheduler.py)" >> $GITHUB_STEP_SUMMARY
        echo "- [Production Starter](./start_production.py)" >> $GITHUB_STEP_SUMMARY