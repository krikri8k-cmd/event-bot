# 🤖 Архитектура разделения основного бота и группового функционала

**Дата:** 14 октября 2025  
**Проект:** EventBot  
**Версия:** 1.0.0

---

## 📋 Содержание

1. [Общая концепция разделения](#общая-концепция-разделения)
2. [Две независимые системы](#две-независимые-системы)
3. [Механизмы изоляции](#механизмы-изоляции)
4. [База данных: разделение таблиц](#база-данных-разделение-таблиц)
5. [Обработчики и роутеры](#обработчики-и-роутеры)
6. [FSM состояния](#fsm-состояния)
7. [Deep Links: связь между ботами](#deep-links-связь-между-ботами)
8. [Примеры кода](#примеры-кода)
9. [Диаграмма архитектуры](#диаграмма-архитектуры)

---

## 🎯 Общая концепция разделения

### Основная идея

**EventBot работает в двух режимах одновременно:**

1. **Основной бот (Private)** - полнофункциональный бот в приватных чатах
2. **Групповой бот (Community)** - упрощенная версия для групповых чатов

**Ключевой принцип:** Эти два режима **полностью изолированы** друг от друга и не пересекаются!

---

## 🔀 Две независимые системы

### 1️⃣ Основной бот (Private Chat Bot)

**Где работает:** Только в приватных чатах (1-на-1 с пользователем)

**Функционал:**
- ✅ Поиск событий по геолокации
- ✅ Настройка радиуса поиска (5-20 км)
- ✅ Интеграция с источниками (KudaGo, BaliForum, etc.)
- ✅ Создание пользовательских событий
- ✅ Система заданий (tasks) и ракет 🚀
- ✅ Управление профилем пользователя
- ✅ AI-генерация событий
- ✅ Карты и маршруты

**Модули:**
```
bot_enhanced_v3.py          # Основной файл с main_router
├─ unified_events_service.py   # Поиск событий
├─ simple_status_manager.py    # Управление событиями
├─ tasks_service.py             # Система заданий
├─ rockets_service.py           # Геймификация
└─ utils/geo_utils.py           # Геолокация
```

**Таблицы БД:**
- `users` - профили пользователей
- `events` (source != 'user') - события из парсеров
- `tasks`, `user_tasks` - система заданий
- `user_participation` - участие в событиях

---

### 2️⃣ Групповой бот (Group Chat Bot)

**Где работает:** Только в групповых чатах (group, supergroup)

**Функционал:**
- ✅ Создание событий участниками группы
- ✅ Просмотр событий конкретной группы
- ✅ Управление событиями (только для админов)
- ✅ Функция "Спрятать бота" (удаление служебных сообщений)
- ✅ Deep-link в основной бот для полного функционала

**Модули:**
```
group_router.py              # Изолированный роутер для групп
├─ group_chat_handlers.py       # FSM для создания событий
├─ community_events_service.py  # Сервис групповых событий
└─ messaging_utils.py           # Трекинг сообщений бота
```

**Таблицы БД:**
- `events_community` - события групповых чатов (изолировано!)
- `bot_messages` - трекинг сообщений для функции "Спрятать бота"
- `chat_settings` - настройки группы (панель-пост)

---

## 🔒 Механизмы изоляции

### 1. Фильтры на уровне роутеров

**Основной роутер (`main_router`):**
```python
# bot_enhanced_v3.py (строки 1277-1279)
main_router = Router()
main_router.message.filter(F.chat.type == "private")
main_router.callback_query.filter(F.message.chat.type == "private")
```

**Групповой роутер (`group_router`):**
```python
# group_router.py (строки 68-69)
group_router.message.filter(F.chat.type.in_({"group", "supergroup"}))
group_router.callback_query.filter(F.message.chat.type.in_({"group", "supergroup"}))
```

**Результат:** 
- Сообщения из приватных чатов **никогда** не попадут в групповой роутер
- Сообщения из групп **никогда** не попадут в основной роутер

---

### 2. Порядок подключения роутеров

```python
# bot_enhanced_v3.py (строки 1285-1290)
dp.include_router(group_router)   # ПЕРВЫМ - групповой роутер
dp.include_router(diag_router)    # Диагностика
dp.include_router(diag)           # Диагностика
dp.include_router(main_router)    # ПОСЛЕДНИМ - основной роутер
```

**Важно:** Порядок имеет значение!
- Групповой роутер проверяется первым
- Основной роутер проверяется последним
- Фильтры гарантируют отсутствие пересечений

---

### 3. Отдельные FSM состояния

**Основной бот:**
```python
class CreateEvent(StatesGroup):
    waiting_for_title = State()
    waiting_for_date = State()
    waiting_for_location = State()
    # ... и т.д.
```

**Групповой бот:**
```python
class GroupCreate(StatesGroup):
    waiting_for_title = State()
    waiting_for_datetime = State()
    waiting_for_city = State()
    waiting_for_location = State()
    waiting_for_description = State()
```

**Результат:** Разные классы состояний = нет конфликтов!

---

### 4. Изоляция на уровне кода

**group_router.py (строки 3-10) - комментарий в начале файла:**
```python
"""
ВАЖНО: Этот модуль полностью изолирован от основного бота!
- Работает ТОЛЬКО в group/supergroup чатах
- НЕ импортирует FSM состояния из основного бота
- НЕ импортирует сервисы из основного бота
- Связь с основным ботом только через deep-link
"""
```

---

## 🗄️ База данных: разделение таблиц

### Схема разделения

```
┌─────────────────────────────────────────────────────────┐
│           ОСНОВНОЙ БОТ (Private)                        │
└─────────────────────────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
    ┌───▼───┐    ┌───▼───┐    ┌───▼────┐
    │ users │    │events │    │ tasks  │
    └───────┘    └───────┘    └────────┘
        │             │             │
        └─────────────┴─────────────┘
                      │
                      │
┌─────────────────────────────────────────────────────────┐
│           ГРУППОВОЙ БОТ (Community)                     │
└─────────────────────────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
  ┌─────▼──────┐ ┌───▼────────┐ ┌──▼───────────┐
  │events_comm │ │bot_messages│ │chat_settings │
  └────────────┘ └────────────┘ └──────────────┘
```

### Таблица `events` vs `events_community`

| Параметр | `events` (основной) | `events_community` (группы) |
|----------|---------------------|----------------------------|
| **Источник** | KudaGo, BaliForum, User | Участники группы |
| **Геопоиск** | ✅ Полный (lat/lng) | ❌ Только город |
| **Видимость** | Глобальная | Только для группы |
| **Поля** | 35 полей | 13 полей |
| **Координаты** | lat, lng (обязательно) | Отсутствуют |
| **Внешние ID** | source, external_id | Нет |
| **Участники** | participants_ids | Нет (планируется) |

### Пример события в `events`

```sql
SELECT id, source, title, lat, lng, starts_at, city
FROM events
WHERE source = 'kudago'
LIMIT 1;

-- Результат:
-- id: 15337
-- source: kudago
-- title: инсталляция U-space «Вишнёвый сад»
-- lat: 59.93178799999995
-- lng: 30.251674
-- starts_at: 2025-10-13 09:00:00
-- city: spb
```

### Пример события в `events_community`

```sql
SELECT id, chat_id, title, starts_at, city
FROM events_community
WHERE chat_id = -1001234567890
LIMIT 1;

-- Результат:
-- id: 1
-- chat_id: -1001234567890
-- title: Bitcoin Meetup Canggu
-- starts_at: 2025-10-14 08:30:00
-- city: bali
-- organizer_id: 456065084
```

---

## 🔄 Обработчики и роутеры

### Структура обработчиков

```
┌──────────────────────────────────────────────┐
│         Telegram Updates                      │
└──────────────┬───────────────────────────────┘
               │
        ┌──────▼──────┐
        │ Dispatcher  │
        └──────┬──────┘
               │
     ┌─────────┴─────────┐
     │                   │
┌────▼─────┐      ┌─────▼──────┐
│  group   │      │   main     │
│ _router  │      │  _router   │
└────┬─────┘      └─────┬──────┘
     │                  │
     │                  │
┌────▼─────────┐  ┌────▼───────────┐
│ F.chat.type  │  │ F.chat.type    │
│ in group/    │  │ == private     │
│ supergroup   │  │                │
└──────────────┘  └────────────────┘
```

### Приоритет обработчиков

1. **group_router** (приоритет 1) - обрабатывает группы
2. **diag_router** (приоритет 2) - диагностика
3. **main_router** (приоритет 3) - обрабатывает приватные чаты

**Важно:** Благодаря фильтрам конфликтов не возникает!

---

## 🎭 FSM состояния

### Проблема: Конфликт состояний в группах

**Сценарий без изоляции:**
```
1. Пользователь A начинает создавать событие: /create
2. Бот: "Введите название"
3. Пользователь B пишет случайное сообщение "Привет всем!"
4. ❌ БАГ: Бот думает что это название события от A!
```

### Решение: Жёсткая привязка к пользователю

**group_chat_handlers.py (строки 74-82):**
```python
# Жёсткие проверки
if message.reply_to_message is None:
    return  # Не ответ - игнорируем

if message.reply_to_message.from_user.id != BOT_ID:
    return  # Не ответ на бота - игнорируем

if message.reply_to_message.message_id != data.get("prompt_msg_id"):
    return  # Не ответ на наш вопрос - игнорируем

if message.from_user.id != data.get("initiator_id"):
    return  # Не тот пользователь - игнорируем
```

### Механизм работы

```
1. Пользователь A: /create
2. Бот запоминает:
   - initiator_id = A
   - prompt_msg_id = 12345
3. Бот: "Введите название" (message_id=12345, ForceReply)
4. Пользователь B: "Привет" (НЕ reply)
   → Игнорируется ✅
5. Пользователь A: "Моё событие" (reply на 12345)
   → Принимается ✅
6. Пользователь C: "Моё событие" (reply на 12345, но от C)
   → Игнорируется ✅
```

**Результат:** Только инициатор может продолжить создание события!

---

## 🔗 Deep Links: связь между ботами

### Концепция

Групповой бот **НЕ имеет** полного функционала основного бота (геопоиск, задания, и т.д.).

**Решение:** Deep Links для перехода в основной бот!

### Примеры Deep Links

**1. Создание события для группы**

```python
# group_router.py (строка 88)
InlineKeyboardButton(
    text="➕ Создать событие", 
    url=f"https://t.me/{username}?start=group_{chat_id}"
)
```

**Что происходит:**
1. Пользователь нажимает кнопку в группе
2. Telegram открывает приватный чат с ботом
3. Бот получает параметр `start=group_-1001234567890`
4. Бот знает, что событие создается для группы `-1001234567890`
5. После создания - событие сохраняется в `events_community`

**2. Переход в полный бот**

```python
# group_router.py (строка 90)
InlineKeyboardButton(
    text="🚀 Полный бот (с геолокацией)", 
    url=f"https://t.me/{username}"
)
```

**Что происходит:**
1. Пользователь нажимает кнопку
2. Открывается приватный чат с ботом
3. Все функции основного бота доступны

---

## 📦 Специальные фичи группового бота

### 1. Функция "Спрятать бота"

**Проблема:** Бот создает много служебных сообщений в группе при создании события

**Решение:** Трекинг всех сообщений бота и их массовое удаление

#### Таблица `bot_messages`

```sql
CREATE TABLE bot_messages (
    id INTEGER PRIMARY KEY,
    chat_id BIGINT NOT NULL,
    message_id BIGINT NOT NULL,
    tag VARCHAR(50),  -- 'panel', 'service', 'notification'
    deleted BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT now()
);
```

#### Механизм работы

```python
# 1. При отправке сообщения - трекаем
await send_tracked(bot, session, 
    chat_id=chat_id,
    text="Событие создано!",
    tag="service"
)
# → Сохраняется в bot_messages

# 2. При нажатии "Спрятать бота"
deleted = await delete_all_tracked(bot, session, chat_id=chat_id)
# → Удаляются все сообщения с deleted=false
```

**Результат:** Чистый чат без служебных сообщений! 🧹

---

### 2. Панель-пост (Panel Post)

**Концепция:** Единое сообщение-панель вместо множества команд

#### Таблица `chat_settings`

```sql
CREATE TABLE chat_settings (
    chat_id BIGINT PRIMARY KEY,
    last_panel_message_id BIGINT,
    muted BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT now()
);
```

#### Механизм работы

```python
# 1. Первый /start в группе
panel_id = await ensure_panel(bot, session, 
    chat_id=chat_id,
    text=PANEL_TEXT,
    kb=group_kb(chat_id)
)
# → Создается панель, message_id сохраняется в chat_settings

# 2. Второй /start в группе
panel_id = await ensure_panel(...)
# → РЕДАКТИРУЕТСЯ существующая панель (не создается новая!)
```

**Результат:** Одна панель вместо спама! 📌

---

## 💡 Примеры кода

### Пример 1: Создание события в группе

**Последовательность:**

```
Группа (-1001234567890)
  ↓
Пользователь нажимает "➕ Создать событие"
  ↓
Deep Link: t.me/EventAroundBot?start=group_-1001234567890
  ↓
Приватный чат с ботом
  ↓
Бот: FSM диалог создания события
  ↓
Сохранение в events_community:
  - chat_id = -1001234567890
  - organizer_id = 456065084
  - title = "Bitcoin Meetup"
  ↓
Уведомление в группу
```

**Код:**

```python
# bot_enhanced_v3.py
@main_router.message(Command("start"))
async def start_private(message: Message, command: CommandObject):
    args = command.args or ""
    
    # Проверяем deep-link для группы
    if args.startswith("group_"):
        chat_id = int(args.replace("group_", ""))
        # Начинаем создание события для группы
        await state.update_data(target_group_id=chat_id)
        await create_group_event_step1(message, state)
    else:
        # Обычный старт основного бота
        await show_main_menu(message)
```

---

### Пример 2: Разделение обработчиков

**Приватный чат:**

```python
# main_router обрабатывает
@main_router.message(Command("events"))
async def show_events_private(message: Message):
    # Поиск событий по геолокации
    events = await search_nearby_events(
        lat=user.last_lat,
        lng=user.last_lng,
        radius=user.default_radius_km
    )
    # Показываем события из таблицы events
```

**Групповой чат:**

```python
# group_router обрабатывает
@group_router.callback_query(F.data == "group_list")
async def show_events_group(callback: CallbackQuery):
    # Показываем только события этой группы
    events = await get_community_events(
        chat_id=callback.message.chat.id
    )
    # Показываем события из таблицы events_community
```

---

## 📊 Диаграмма архитектуры

### Полная схема взаимодействия

```
┌─────────────────────────────────────────────────────────────┐
│                    TELEGRAM UPDATES                          │
└────────────────────┬────────────────────────────────────────┘
                     │
            ┌────────▼─────────┐
            │   Dispatcher     │
            │   (bot_enhanced  │
            │    _v3.py)       │
            └────────┬─────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
         │                       │
┌────────▼─────────┐    ┌───────▼──────────┐
│  GROUP_ROUTER    │    │   MAIN_ROUTER    │
│  (group_router.py│    │  (bot_enhanced   │
│                  │    │   _v3.py)        │
└────────┬─────────┘    └───────┬──────────┘
         │                      │
         │                      │
┌────────▼─────────┐    ┌───────▼──────────┐
│  F.chat.type.in  │    │  F.chat.type ==  │
│  (group,         │    │  private         │
│   supergroup)    │    │                  │
└────────┬─────────┘    └───────┬──────────┘
         │                      │
         │                      │
┌────────▼─────────┐    ┌───────▼──────────┐
│ GroupCreate FSM  │    │ CreateEvent FSM  │
│ (group_chat_     │    │ (bot_enhanced    │
│  handlers.py)    │    │  _v3.py)         │
└────────┬─────────┘    └───────┬──────────┘
         │                      │
         │                      │
┌────────▼─────────┐    ┌───────▼──────────┐
│ community_events │    │ unified_events   │
│ _service.py      │    │ _service.py      │
└────────┬─────────┘    └───────┬──────────┘
         │                      │
         │                      │
┌────────▼─────────┐    ┌───────▼──────────┐
│ events_community │    │     events       │
│    (таблица)     │    │    (таблица)     │
└──────────────────┘    └──────────────────┘
```

### База данных: схема разделения

```
┌───────────────────────────────────────────────────────┐
│                   PostgreSQL                          │
└───────────────────────────────────────────────────────┘
                         │
         ┌───────────────┴───────────────┐
         │                               │
┌────────▼──────────┐          ┌─────────▼─────────┐
│  ОСНОВНОЙ БОТ     │          │  ГРУППОВОЙ БОТ    │
│  (Private)        │          │  (Community)      │
└────────┬──────────┘          └─────────┬─────────┘
         │                               │
    ┌────┴────┐                    ┌─────┴─────┐
    │         │                    │           │
┌───▼──┐ ┌───▼────┐         ┌─────▼────┐ ┌───▼────┐
│users │ │events  │         │events_   │ │bot_    │
│      │ │        │         │community │ │messages│
│      │ │source: │         │          │ │        │
│      │ │-kudago │         │chat_id:  │ │chat_id:│
│      │ │-bali   │         │group     │ │group   │
│      │ │-user   │         │          │ │        │
└──────┘ └────────┘         └──────────┘ └────────┘
    │         │                    │           │
    │         │                    │           │
┌───▼──┐ ┌───▼────┐         ┌─────▼──────┐    │
│tasks │ │user_   │         │chat_       │    │
│      │ │partic  │         │settings    │    │
└──────┘ └────────┘         └────────────┘    │
                                    │          │
                            ┌───────┴──────────┘
                            │
                    ИЗОЛЯЦИЯ! Нет связей!
```

---

## 🔑 Ключевые принципы изоляции

### 1. Фильтры на роутерах

```python
# ✅ ПРАВИЛЬНО
main_router.message.filter(F.chat.type == "private")
group_router.message.filter(F.chat.type.in_({"group", "supergroup"}))

# ❌ НЕПРАВИЛЬНО (без фильтров)
main_router = Router()
group_router = Router()
# Конфликты гарантированы!
```

---

### 2. Отдельные таблицы БД

```python
# ✅ ПРАВИЛЬНО
class Event(Base):
    """Для основного бота"""
    __tablename__ = "events"
    
class CommunityEvent(Base):
    """Для группового бота"""
    __tablename__ = "events_community"

# ❌ НЕПРАВИЛЬНО (одна таблица)
# Сложно разделить логику, риск конфликтов
```

---

### 3. Разные FSM состояния

```python
# ✅ ПРАВИЛЬНО
class CreateEvent(StatesGroup):      # Для приватных чатов
    waiting_for_title = State()

class GroupCreate(StatesGroup):      # Для групп
    waiting_for_title = State()

# ❌ НЕПРАВИЛЬНО (общие состояния)
# В группах будут конфликты между пользователями
```

---

### 4. Отдельные сервисы

```python
# ✅ ПРАВИЛЬНО
class UnifiedEventsService:          # Для основного бота
    def search_nearby_events(...)

class CommunityEventsService:        # Для группового бота
    def get_community_events(...)

# ❌ НЕПРАВИЛЬНО (общий сервис)
# Сложная логика, много if-ов
```

---

## 🎯 Итоговая схема разделения

### Что где обрабатывается?

| Функция | Основной бот (Private) | Групповой бот (Community) |
|---------|------------------------|---------------------------|
| **Геопоиск** | ✅ Да | ❌ Нет |
| **Создание событий** | ✅ Да (в `events`) | ✅ Да (в `events_community`) |
| **Просмотр событий** | ✅ Все глобальные | ✅ Только своей группы |
| **Задания** | ✅ Да | ❌ Нет |
| **Ракеты** | ✅ Да | ❌ Нет |
| **AI генерация** | ✅ Да | ❌ Нет |
| **Карты** | ✅ Да | ❌ Нет |
| **Deep Links** | ❌ Нет | ✅ Да (в основной бот) |
| **Панель-пост** | ❌ Нет | ✅ Да |
| **Спрятать бота** | ❌ Нет | ✅ Да |

---

## 🚀 Преимущества такой архитектуры

### ✅ Плюсы

1. **Чистое разделение ответственности**
   - Код основного бота не захламлен групповой логикой
   - Групповой бот максимально простой

2. **Отсутствие конфликтов**
   - Фильтры гарантируют изоляцию
   - Разные FSM состояния

3. **Простота поддержки**
   - Легко найти код нужного функционала
   - Изменения в одном боте не влияют на другой

4. **Масштабируемость**
   - Можно вынести групповой бот в отдельный процесс
   - Можно даже сделать отдельный Telegram бот для групп

5. **Безопасность**
   - Групповой бот имеет минимальные права
   - Основной бот не доступен в группах

---

### ⚠️ Минусы

1. **Дублирование кода**
   - Некоторые функции реализованы дважды
   - Например, создание событий

2. **Сложность deep-links**
   - Нужно передавать параметры между режимами
   - Пользователь может запутаться

3. **Две базы событий**
   - `events` и `events_community` не связаны
   - Нельзя показать события из группы в геопоиске

---

## 📝 Рекомендации по развитию

### Краткосрочные (1-2 недели)

1. ✅ Добавить документацию по deep-links для пользователей
2. ✅ Улучшить сообщения при переходе между режимами
3. ✅ Добавить больше примеров в GROUP_SETUP_GUIDE.md

### Среднесрочные (1-2 месяца)

4. ⚙️ Рассмотреть объединение `events` и `events_community`
   - Добавить поле `scope` ('global', 'group')
   - Упростит архитектуру

5. ⚙️ Добавить участников в групповые события
   - Реакции "Я пойду" / "Не пойду"
   - Счетчик участников

6. ⚙️ Улучшить панель-пост
   - Показывать статистику группы
   - Кнопка "Следующее событие"

### Долгосрочные (3-6 месяцев)

7. 📊 Рассмотреть разделение на два бота
   - Основной бот для приватных чатов
   - Отдельный GroupBot для групп
   - Общая база данных

8. 📊 Добавить webhook для событий
   - Уведомления в группу о новых событиях
   - Интеграция с календарями

---

## 🎯 Выводы

### Основные принципы

1. **Жёсткая изоляция** - два независимых режима работы
2. **Фильтры на роутерах** - гарантия отсутствия пересечений
3. **Разные таблицы БД** - `events` vs `events_community`
4. **Deep Links** - связь между режимами
5. **Трекинг сообщений** - функция "Спрятать бота"

### Ключевые файлы

```
bot_enhanced_v3.py           # Основной бот + диспетчер
├─ main_router               # Только приватные чаты
│
group_router.py              # Групповой бот
├─ group_router              # Только группы
│
group_chat_handlers.py       # FSM для групп
├─ GroupCreate               # Состояния создания
│
community_events_service.py  # Сервис групповых событий
├─ CommunityEventsService    # CRUD для events_community
│
messaging_utils.py           # Трекинг сообщений
├─ ensure_panel()            # Панель-пост
├─ send_tracked()            # Трекинг
└─ delete_all_tracked()      # Удаление
```

---

**Архитектура проверена в бою и работает отлично!** 🚀

Разделение основного бота и группового функционала позволяет:
- ✅ Избежать конфликтов
- ✅ Упростить код
- ✅ Легко масштабировать
- ✅ Обеспечить чистые группы

---

**Дата:** 14 октября 2025  
**Автор:** AI Assistant (Claude)  
**Версия:** 1.0

