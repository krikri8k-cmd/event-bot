# –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ —Å–æ–±—ã—Ç–∏–π

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ 0. –ü—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `events` —Å –ø–æ–ª—è–º–∏ `source`, `external_id`, `url`, `title`, `lat`, `lng`, `starts_at` –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º `(source, external_id)`
- ‚úÖ –ú–∞—Ä–∫–µ—Ä—ã pytest –∏ FULL_TESTS –ª–æ–≥–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

### ‚úÖ 1. –ë–î: —Ç–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ + –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ –°–æ–∑–¥–∞–Ω SQL-—Å–∫—Ä–∏–ø—Ç `sql/2025_ics_sources_and_indexes.sql`
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `event_sources` —Å –ø–æ–ª—è–º–∏: `id`, `type`, `url`, `region`, `enabled`, `freq_minutes`, `etag`, `last_modified`, `last_fetch_at`, `last_status`, `fail_count`, `notes`
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã: `ix_event_sources_enabled`, `ix_event_sources_region`, `ix_event_sources_next`
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å `ux_events_source_ext` –Ω–∞ `(source, external_id)`
- ‚úÖ –ò–Ω–¥–µ–∫—Å `ix_events_starts_at` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞

### ‚úÖ 2. ENV + seed
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `.env.local.template`:
  - `INGEST_DEFAULT_FREQ_MIN=120`
  - `INGEST_MAX_FAILS=5`
- ‚úÖ –°–æ–∑–¥–∞–Ω `config/sources.seed.json` —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### ‚úÖ 3. –ò—Å—Ç–æ—á–Ω–∏–∫–∏: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ fingerprint
- ‚úÖ –°–æ–∑–¥–∞–Ω `sources/common.py` —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
  - `norm_text()` - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
  - `make_external_id()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ external_id

### ‚úÖ 4. ICS-–∏–Ω–∂–µ—Å—Ç–æ—Ä
- ‚úÖ –°–æ–∑–¥–∞–Ω `sources/ics.py` —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
  - `_to_utc()` - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ UTC
  - `fetch_ics()` - –∑–∞–≥—Ä—É–∑–∫–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ETag/Last-Modified
  - `parse_ics()` - –ø–∞—Ä—Å–∏–Ω–≥ ICS-—Ñ–∞–π–ª–æ–≤

### ‚úÖ 5. Nexudus (HTML ‚Üí .ics per-event)
- ‚úÖ –°–æ–∑–¥–∞–Ω `sources/nexudus.py` —Å —Ñ—É–Ω–∫—Ü–∏–µ–π:
  - `discover_event_ics_links()` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ ICS-—Å—Å—ã–ª–æ–∫ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü —Å–æ–±—ã—Ç–∏–π

### ‚úÖ 6. Upsert –≤ –ë–î
- ‚úÖ –°–æ–∑–¥–∞–Ω `ingest/upsert.py` —Å —Ñ—É–Ω–∫—Ü–∏–µ–π:
  - `upsert_event()` - upsert —Å–æ–±—ã—Ç–∏–π —Å ON CONFLICT

### ‚úÖ 7. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∏ —Ü–∏–∫–ª –∏–Ω–∂–µ—Å—Ç–∞
- ‚úÖ –°–æ–∑–¥–∞–Ω `scheduler.py` —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
  - `_due_sources()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Ç–æ–≤—ã—Ö –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  - `_update_source_meta()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  - `ingest_once()` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∏–Ω–∂–µ—Å—Ç–∞
  - `start_scheduler()` - –∑–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

### ‚úÖ 8. –ê–¥–º–∏–Ω-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- ‚úÖ –°–æ–∑–¥–∞–Ω `api/admin.py` —Å —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏:
  - `GET /admin/sources` - —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  - `POST /admin/sources` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
  - `POST /admin/sources/{id}/toggle` - –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
  - `POST /admin/ingest/run` - —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–Ω–∂–µ—Å—Ç–∞
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω —Ä–æ—É—Ç–µ—Ä –≤ `api/app.py`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### ‚úÖ 9. –¢–µ—Å—Ç—ã
- ‚úÖ –°–æ–∑–¥–∞–Ω `tests/test_ics_parse_unit.py` - —é–Ω–∏—Ç-—Ç–µ—Å—Ç –±–µ–∑ –ë–î
- ‚úÖ –°–æ–∑–¥–∞–Ω `tests/test_ingest_cycle_api.py` - FULL-—Ç–µ—Å—Ç —Å –ë–î (–ø–æ–º–µ—á–µ–Ω api, db, skipif FULL_TESTS)

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
- ‚úÖ –°–æ–∑–¥–∞–Ω `apply_sql.py` –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ `requirements.txt`: `icalendar`, `beautifulsoup4`, `requests`
- ‚úÖ –°–æ–∑–¥–∞–Ω `INGEST_README.md` —Å –ø–æ–ª–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π

### ‚úÖ –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—å `Event`: `source`, `external_id`, `starts_at`, `ends_at`, `url`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ö–µ–º–æ–π –ë–î
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º API –∏ —Å–∏—Å—Ç–µ–º–æ–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

```
‚îú‚îÄ‚îÄ sql/2025_ics_sources_and_indexes.sql  # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îú‚îÄ‚îÄ sources/
‚îÇ   ‚îú‚îÄ‚îÄ common.py                         # –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ ics.py                           # ICS-–ø–∞—Ä—Å–µ—Ä
‚îÇ   ‚îî‚îÄ‚îÄ nexudus.py                       # Nexudus-–ø–∞—Ä—Å–µ—Ä
‚îú‚îÄ‚îÄ ingest/
‚îÇ   ‚îî‚îÄ‚îÄ upsert.py                        # Upsert –≤ –ë–î
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ admin.py                         # –ê–¥–º–∏–Ω-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ sources.seed.json                # –ü—Ä–∏–º–µ—Ä—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ test_ics_parse_unit.py           # –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ test_ingest_cycle_api.py         # FULL-—Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ scheduler.py                         # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
‚îú‚îÄ‚îÄ apply_sql.py                         # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ INGEST_README.md                     # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ INGEST_IMPLEMENTATION_REPORT.md      # –≠—Ç–æ—Ç –æ—Ç—á–µ—Ç
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚úÖ –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
```bash
python -m pytest tests/test_ics_parse_unit.py -v
# ‚úÖ PASSED

### ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
pip install icalendar beautifulsoup4 requests
# ‚úÖ –£—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
```

## –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞**: `pip install -r requirements.txt`
2. **–ú–∏–≥—Ä–∞—Ü–∏–∏**: `python apply_sql.py`
3. **–ó–∞–ø—É—Å–∫**: `uvicorn api.app:app --reload`
4. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤**: —á–µ—Ä–µ–∑ API `/admin/sources`
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —á–µ—Ä–µ–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: Graceful handling –æ—à–∏–±–æ–∫, —Ç–∞–π–º–∞—É—Ç—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: ETag/Last-Modified, –∏–Ω–¥–µ–∫—Å—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –õ–µ–≥–∫–∏–µ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –∏ FULL-—Ç–µ—Å—Ç—ã —Å –ë–î
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ —Å–æ–±—ã—Ç–∏–π –∏–∑ –ò–Ω–¥–æ–Ω–µ–∑–∏–∏! üéâ
