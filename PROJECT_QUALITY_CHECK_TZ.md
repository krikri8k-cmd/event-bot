# üìã –¢–ó –¥–ª—è Cursor: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ—Å–ª–µ —á–∏—Å—Ç–∫–∏

## üéØ –¶–µ–ª—å

–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –ø–æ—Å–ª–µ —Ä–µ–≤–∏–∑–∏–∏:
- –≤–µ—Å—å –∫–æ–¥ –ø—Ä–∏–≤–µ–¥—ë–Ω –∫ –µ–¥–∏–Ω–æ–º—É —Å—Ç–∏–ª—é,
- —Å–æ–±—ã—Ç–∏—è –ø–∞—Ä—Å—è—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ,
- —Å—Å—ã–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ,
- –ø–æ–∏—Å–∫ –ø–æ —Ä–∞–¥–∏—É—Å—É –∏ –º–æ–º–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –∑–∞–¥—É–º–∞–Ω–æ.

---

## üîß –ó–∞–¥–∞—á–∏ –∏ –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

1. **–ü—Ä–æ–≥–æ–Ω –ª–∏–Ω—Ç–µ—Ä–æ–≤ –∏ –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
   ```bash
   ruff check . --fix
   black . --check
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è** (–≤—Å–µ –ª–∏ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏–∑ `app.local.env`):
   ```python
   import os
   from config import load_settings
   
   settings = load_settings()
   required_keys = [
       "TELEGRAM_TOKEN", "DATABASE_URL", "DEFAULT_RADIUS_KM",
       "MOMENTS_ENABLE", "MOMENT_TTL_OPTIONS", "MOMENT_DAILY_LIMIT",
       "AI_PARSE_ENABLE", "ENABLE_MEETUP_API", "ENABLE_ICS_FEEDS",
       "GEOCODE_ENABLE", "GOOGLE_MAPS_API_KEY"
   ]
   
   missing = [k for k in required_keys if not getattr(settings, k.lower(), None)]
   print("MISSING:", missing or "OK")
   ```

üëâ **–û–∂–∏–¥–∞–Ω–∏–µ:** –≤—Å–µ –∫–ª—é—á–∏ –Ω–∞–π–¥–µ–Ω—ã, –ª–∏–Ω—Ç–µ—Ä—ã –±–µ–∑ –æ—à–∏–±–æ–∫.

---

### 2. –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã

1. **–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å —Ç–µ—Å—Ç—ã –∏ –æ–Ω–∏ –∑–µ–ª—ë–Ω—ã–µ:**
   ```bash
   python -m pytest tests/ -v --tb=short
   ```

2. **–ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø–æ–∫—Ä—ã–≤–∞—Ç—å:**
   - `haversine_km` ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π
   - `sanitize_url` ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º—É—Å–æ—Ä–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ (`example.com`, –ø—É—Å—Ç—ã–µ Google Calendar)
   - `prepare_events_for_feed` ‚Äî —É–±–∏—Ä–∞–µ—Ç –¥—É–±–ª–∏ –∏ –ø—É—Å—Ç—ã–µ —Å–æ–±—ã—Ç–∏—è
   - `render_event_html` ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ ¬´–ò—Å—Ç–æ—á–Ω–∏–∫¬ª –∏ ¬´–ú–∞—Ä—à—Ä—É—Ç¬ª

üëâ **–û–∂–∏–¥–∞–Ω–∏–µ:** –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç.

---

### 3. Dry-run –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. **–°–æ–∑–¥–∞—Ç—å `tools/dry_run.py`**, –∫–æ—Ç–æ—Ä—ã–π –∏–º–∏—Ç–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   ```bash
   python tools/dry_run.py --lat -8.5069 --lon 115.2625 --radius 10 --when today --verbose
   ```

2. **–õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å:**
   - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (`ics=`, `meetup=`, `ai=`, `moments=`)
   - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö/—É–¥–∞–ª—ë–Ω–Ω—ã—Ö
   - –∏—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º, –≤—Ä–µ–º–µ–Ω–µ–º, —Å—Å—ã–ª–∫–æ–π

üëâ **–û–∂–∏–¥–∞–Ω–∏–µ:** –º–∏–Ω–∏–º—É–º 2‚Äì3 –≤–∞–ª–∏–¥–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è —Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏.

---

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

1. **–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–≤–µ–∂–∏–µ —Å–æ–±—ã—Ç–∏—è:**
   ```sql
   SELECT source, COUNT(*) FROM events 
   WHERE created_at_utc > NOW() - INTERVAL '1 day'
   GROUP BY source;
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—É–±–ª–∏:**
   ```sql
   SELECT title, starts_at::date, location_name, COUNT(*) 
   FROM events 
   GROUP BY 1,2,3 
   HAVING COUNT(*) > 1;
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–º–µ–Ω—Ç—ã:**
   ```sql
   SELECT 
     COUNT(*) as total_moments,
     COUNT(*) FILTER (WHERE is_active = true AND expires_at > NOW()) as active_moments,
     COUNT(*) FILTER (WHERE is_active = true AND expires_at <= NOW()) as expired_moments
   FROM moments;
   ```

üëâ **–û–∂–∏–¥–∞–Ω–∏–µ:** –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ—Ç, —Å–æ–±—ã—Ç–∏—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è.

---

### 5. –°–º–æ—É–∫-—Ç–µ—Å—Ç Telegram

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∂–∏–º:**
   - –µ—Å–ª–∏ `webhook` ‚Üí `/health` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `200 OK`, `getWebhookInfo` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–µ—Ä–Ω—ã–π URL
   - –µ—Å–ª–∏ `polling` ‚Üí –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

2. **–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é:**
   - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ö–µ–¥–µ—Ä —Å–æ —Å—á—ë—Ç—á–∏–∫–æ–º (`source=?, user=?, moments=?`)
   - –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç **–Ω–∞–∑–≤–∞–Ω–∏–µ, –≤—Ä–µ–º—è, –º–µ—Å—Ç–æ, –ò—Å—Ç–æ—á–Ω–∏–∫ (–∫–ª–∏–∫), –ú–∞—Ä—à—Ä—É—Ç (–∫–ª–∏–∫)**
   - –ø–∞–≥–∏–Ω–∞—Ü–∏—è ‚óÄÔ∏è‚ñ∂Ô∏è —Ä–∞–±–æ—Ç–∞–µ—Ç
   - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ä–∞–¥–∏—É—Å–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–º–µ–Ω—Ç—ã:**
   - –ª–∏–º–∏—Ç 2 –≤ –¥–µ–Ω—å
   - TTL —Ç–æ–ª—å–∫–æ 30, 60 –∏–ª–∏ 120 –º–∏–Ω—É—Ç
   - –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è ¬´–ê–≤—Ç–æ—Ä @username¬ª, –∞ –Ω–µ ¬´–ò—Å—Ç–æ—á–Ω–∏–∫¬ª

---

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫ –∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤

- –í—Å–µ ¬´–ò—Å—Ç–æ—á–Ω–∏–∫¬ª –¥–æ–ª–∂–Ω—ã –≤–µ—Å—Ç–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–±—ã—Ç–∏–π
- ¬´–ú–∞—Ä—à—Ä—É—Ç¬ª –¥–æ–ª–∂–µ–Ω –≤–µ—Å—Ç–∏ –Ω–∞ Google Maps —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å–æ–º
- –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
  - `sanitize_url(): passed` –¥–ª—è –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
  - `blocked by URL_BLOCKLIST` –¥–ª—è –º—É—Å–æ—Ä–Ω—ã—Ö

---

### 7. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –û–¥–∏–Ω –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø–∞—Ä—Å–∏–Ω–≥–∞ ‚â§ 30 —Å–µ–∫—É–Ω–¥
- –ì–µ–æ–∫–æ–¥ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è (ttl=86400)
- –í –ª–æ–≥–∞—Ö —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤ (`fetch_ics`, `parse_html`, `geocode`)

---

### 8. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/diag_all`**, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∑–∞ 24 —á–∞—Å–∞
- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
- —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (ICS/Meetup/AI –ø–∞—Ä—Å–µ—Ä—ã)
- —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

1. ‚úÖ –ö–æ–¥ —á–∏—Å—Ç—ã–π, –ª–∏–Ω—Ç–µ—Ä—ã –∑–µ–ª—ë–Ω—ã–µ
2. ‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ `app.local.env`
3. ‚úÖ –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
4. ‚úÖ Dry-run –≤—ã–≤–æ–¥–∏—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
5. ‚úÖ –í –ë–î –Ω–µ—Ç –¥—É–±–ª–µ–π
6. ‚úÖ –í Telegram: –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ, –ø–∞–≥–∏–Ω–∞—Ü–∏—è –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ä–∞–¥–∏—É—Å–∞ —Ä–∞–±–æ—Ç–∞—é—Ç
7. ‚úÖ –ú–æ–º–µ–Ω—Ç—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã (2/–¥–µ–Ω—å, TTL 30-120 –º–∏–Ω)
8. ‚úÖ `/diag_all` –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

---

## üöÄ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
```python
# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è utils/geo.py
from utils.geo_utils import haversine_km, bbox_around, validate_coordinates
from api.services.events import get_events_nearby
from bot_enhanced_v3 import prepare_events_for_feed, render_event_html
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–º–µ–Ω—Ç–æ–≤
```python
from config import load_settings
settings = load_settings()
assert settings.moments_enable == True
assert settings.moment_ttl_options == [30, 60, 120]
assert settings.moment_daily_limit == 2
assert settings.moment_max_radius_km == 20
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
assert settings.enable_meetup_api == True
assert settings.enable_ics_feeds == True
assert len(settings.ics_feeds) > 0
```

---

## üìù –û—Ç—á—ë—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

```
# üîç –û—Ç—á—ë—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞

## ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- [ ] –õ–∏–Ω—Ç–µ—Ä—ã –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
- [ ] Dry-run –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- [ ] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- [ ] Telegram –±–æ—Ç
- [ ] –°—Å—ã–ª–∫–∏ –∏ –º–∞—Ä—à—Ä—É—Ç—ã
- [ ] –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- [ ] –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –°–æ–±—ã—Ç–∏–π –≤ –ë–î: X
- –ê–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤: Y
- –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤: Z
- –í—Ä–µ–º—è –ø–∞—Ä—Å–∏–Ω–≥–∞: N —Å–µ–∫

## üö® –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
(–µ—Å–ª–∏ –µ—Å—Ç—å)

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
(–µ—Å–ª–∏ –µ—Å—Ç—å)
```

---

**–ì–æ—Ç–æ–≤–æ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é!** üöÄ
