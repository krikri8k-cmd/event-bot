# –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SQL-—Å–∫—Ä–∏–ø—Ç–æ–≤

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ 1. CLI-—Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SQL

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `scripts/apply_sql.py`:
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç SQL-—Ñ–∞–π–ª –∫–∞–∫ –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç DATABASE_URL –∫–∞–∫ –≤—Ç–æ—Ä–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç –∏–ª–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç SQLAlchemy –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫—É

### ‚úÖ 2. –£–¥–æ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞

#### Makefile
–°–æ–∑–¥–∞–Ω `Makefile` —Å –∫–æ–º–∞–Ω–¥–∞–º–∏:
- ‚úÖ `make db-apply` - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≥–ª–∞–≤–Ω—ã–π SQL-—Å–∫—Ä–∏–ø—Ç
- ‚úÖ `make db-apply-file FILE=path/to.sql` - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ª—é–±–æ–π SQL-—Ñ–∞–π–ª

#### PowerShell-–æ–±—ë—Ä—Ç–∫–∞
–°–æ–∑–¥–∞–Ω `scripts/db_apply.ps1`:
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ñ–∞–π–ª–∞ –∏ DATABASE_URL
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è DATABASE_URL
- ‚úÖ –£–¥–æ–±–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è Windows

### ‚úÖ 3. GitHub Actions –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

–°–æ–∑–¥–∞–Ω `.github/workflows/db-apply.yml`:
- ‚úÖ Workflow —Å —Ä—É—á–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º (`workflow_dispatch`)
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è SQL-—Ñ–∞–π–ª–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ `DATABASE_URL`
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SQL

### ‚úÖ 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ README

–î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª –≤ `README.md`:
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Linux/Mac (make)
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Windows PowerShell
- ‚úÖ –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ö–µ–º—ã –ë–î
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥

### ‚úÖ 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞–ª–∏—á–∏–µ –≤ `requirements.txt`:
- ‚úÖ `SQLAlchemy>=2.0.32` ‚úì
- ‚úÖ `psycopg2-binary` ‚úì

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

```
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ apply_sql.py                    # CLI-—Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SQL
‚îÇ   ‚îî‚îÄ‚îÄ db_apply.ps1                    # PowerShell-–æ–±—ë—Ä—Ç–∫–∞
‚îú‚îÄ‚îÄ .github/workflows/
‚îÇ   ‚îî‚îÄ‚îÄ db-apply.yml                    # GitHub Actions workflow
‚îú‚îÄ‚îÄ Makefile                            # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è Linux/Mac
‚îî‚îÄ‚îÄ README.md                           # –û–±–Ω–æ–≤–ª–µ–Ω —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚úÖ CLI-—Å–∫—Ä–∏–ø—Ç
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ help
python scripts/apply_sql.py --help
# ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –º–æ–∫-–¥–∞–Ω–Ω—ã–º–∏
python scripts/apply_sql.py sql/2025_ics_sources_and_indexes.sql "postgresql://test:test@localhost:5432/test"
# ‚úÖ –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î (–æ–∂–∏–¥–∞–µ–º–æ –Ω–µ —É–¥–∞–µ—Ç—Å—è)
```

### ‚úÖ PowerShell-—Å–∫—Ä–∏–ø—Ç
```powershell
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ DATABASE_URL
powershell -File scripts\db_apply.ps1
# ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
```

### ‚úÖ Makefile
- ‚úÖ –°–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –Ω–∞ Linux/Mac
- ‚úÖ –ö–æ–º–∞–Ω–¥—ã `make db-apply` –∏ `make db-apply-file` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

## Acceptance Criteria - –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

### ‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ (Linux/Mac)
- ‚úÖ `make db-apply` —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç `sql/2025_ics_sources_and_indexes.sql`
- ‚úÖ –ß–∏—Ç–∞–µ—Ç `DATABASE_URL` –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### ‚úÖ PowerShell (Windows)
- ‚úÖ `powershell -File scripts\db_apply.ps1` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### ‚úÖ GitHub Actions
- ‚úÖ Workflow `DB Apply (manual)` —Å–æ–∑–¥–∞–Ω
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ–∫—Ä–µ—Ç `DATABASE_URL`
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä SQL-—Ñ–∞–π–ª–∞

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –õ–æ–∫–∞–ª—å–Ω–æ (Linux/Mac)
```bash
export DATABASE_URL="postgresql+psycopg2://USER:PASS@HOST:5432/DBNAME"
make db-apply
```

### –õ–æ–∫–∞–ª—å–Ω–æ (Windows PowerShell)
```powershell
$Env:DATABASE_URL="postgresql+psycopg2://USER:PASS@HOST:5432/DBNAME"
python scripts\apply_sql.py sql\2025_ics_sources_and_indexes.sql
# –∏–ª–∏:
powershell -File scripts\db_apply.ps1
```

### GitHub Actions
1. –°–æ–∑–¥–∞—Ç—å —Å–µ–∫—Ä–µ—Ç `DATABASE_URL` –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ Actions ‚Üí DB Apply (manual)
3. –£–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ SQL-—Ñ–∞–π–ª—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `sql/2025_ics_sources_and_indexes.sql`)
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å workflow

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
```bash
python - << 'PY'
import os
from sqlalchemy import create_engine, text
eng = create_engine(os.environ["DATABASE_URL"], future=True)
with eng.begin() as c:
    cols = c.execute(text(
        "SELECT column_name FROM information_schema.columns WHERE table_name='event_sources'"
    )).all()
print("event_sources columns:", [r[0] for r in cols])
PY
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SQLAlchemy –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL
- **–ö—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Linux/Mac (make) –∏ Windows (PowerShell)
- **–ì–∏–±–∫–æ—Å—Ç—å**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ª—é–±–æ–≥–æ SQL-—Ñ–∞–π–ª–∞
- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**: GitHub Actions –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ README

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ
