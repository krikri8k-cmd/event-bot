# üõ°Ô∏è –°—Ç–∞—Ç—É—Å –∑–∞—â–∏—Ç—ã –æ—Ç OOM

## ‚úÖ –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏

### 1. –û–≥—Ä–∞–Ω–∏—á–∏–ª–∏ –≤—Å–µ –∫—ç—à–∏:
- ‚úÖ **KudaGo –∫—ç—à**: –º–∞–∫—Å–∏–º—É–º 500 –∑–∞–ø–∏—Å–µ–π (–±—ã–ª–æ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
- ‚úÖ **Geocode –∫—ç—à**: –º–∞–∫—Å–∏–º—É–º 1000 –∑–∞–ø–∏—Å–µ–π
- ‚úÖ **–ê–¥–º–∏–Ω—ã –≥—Ä—É–ø–ø**: –º–∞–∫—Å–∏–º—É–º 200 –≥—Ä—É–ø–ø
- ‚úÖ **–ú–µ—Ç—Ä–∏–∫–∏ Health**: –º–∞–∫—Å–∏–º—É–º 1000 –∑–∞–ø–∏—Å–µ–π
- ‚úÖ **Callbacks**: –º–∞–∫—Å–∏–º—É–º 5000 –∑–∞–ø–∏—Å–µ–π

### 2. –û–≥—Ä–∞–Ω–∏—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏:
- ‚úÖ **user_state**: –º–∞–∫—Å–∏–º—É–º 200 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–±—ã–ª–æ 500)
- ‚úÖ **prepared_events**: –º–∞–∫—Å–∏–º—É–º 50 –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–∏ Memory Guard: 10)
- ‚úÖ **TTL user_state**: 15 –º–∏–Ω—É—Ç (–±—ã–ª–æ 30 –º–∏–Ω—É—Ç)

### 3. –î–æ–±–∞–≤–∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É:
- ‚úÖ **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- ‚úÖ **Memory Guard**: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ 512 –ú–ë
- ‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ 70%** —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏**: –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

### 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–ª–∏ —Ä–µ—Å—É—Ä—Å—ã:
- ‚úÖ **Event Loop**: –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ–º —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏**: –º–∞–∫—Å–∏–º—É–º 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ **–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –∫–∞—Ä—Ç**: —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

## üìä –¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –õ–∏–º–∏—Ç | –û—á–∏—Å—Ç–∫–∞ |
|-----------|-------|---------|
| **Memory Guard –ø–æ—Ä–æ–≥** | 512 –ú–ë | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è |
| **user_state** | 200 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç |
| **prepared_events** | 50 –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | –ü—Ä–∏ Memory Guard: 10 |
| **KudaGo –∫—ç—à** | 500 –∑–∞–ø–∏—Å–µ–π | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è |
| **Geocode –∫—ç—à** | 1000 –∑–∞–ø–∏—Å–µ–π | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è |
| **–ú–µ—Ç—Ä–∏–∫–∏ Health** | 1000 –∑–∞–ø–∏—Å–µ–π | –ö–∞–∂–¥—ã–µ 100 –∑–∞–ø–∏—Å–µ–π |
| **Callbacks** | 5000 –∑–∞–ø–∏—Å–µ–π | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è |

## üéØ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å OOM

### ‚úÖ **–í—ã—Å–æ–∫–∞—è –∑–∞—â–∏—Ç–∞** (95%+ —Å–ª—É—á–∞–µ–≤):
- –í—Å–µ –∫—ç—à–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- Memory Guard –∞–∫—Ç–∏–≤–µ–Ω
- –†–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### ‚ö†Ô∏è **–ú–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å** –≤ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö:
- –û—á–µ–Ω—å –º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (1000+)
- –û—á–µ–Ω—å –±–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ API (–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (< 1GB)

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:

**–•–æ—Ä–æ—à–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:**
```
üìä MEMORY STATS: user_state=123, prepared_events=456, memory=234.5MB
üßπ –û—á–∏—Å—Ç–∫–∞ user_state: —É–¥–∞–ª–µ–Ω–æ 50 —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö, –æ—Å—Ç–∞–ª–æ—Å—å 150 –∑–∞–ø–∏—Å–µ–π
```

**–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ):**
```
‚ö†Ô∏è MEMORY GUARD: –ü–∞–º—è—Ç—å –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –ø–æ—Ä–æ–≥ (600.0MB > 512MB), –≤—ã–ø–æ–ª–Ω—è—é –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É
üßπ MEMORY GUARD: –£–¥–∞–ª–µ–Ω–æ 140 –∑–∞–ø–∏—Å–µ–π –∏–∑ user_state
‚úÖ MEMORY GUARD: –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–∞–º—è—Ç—å: 450.0MB (–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ 150.0MB)
```

**–ü—Ä–æ–±–ª–µ–º–∞ (–µ—Å–ª–∏ –≤–∏–¥–∏—à—å —á–∞—Å—Ç–æ):**
```
‚ùå Out of Memory (OOM)
```

## üö® –ï—Å–ª–∏ OOM –≤—Å–µ –µ—â–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏
```bash
railway logs | grep "MEMORY\|OOM"
```

### –®–∞–≥ 2: –°–Ω–∏–∑—å –ø–æ—Ä–æ–≥–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
–í `bot_enhanced_v3.py`:
```python
MEMORY_THRESHOLD_MB = 256  # –í–º–µ—Å—Ç–æ 512
USER_STATE_MAX_SIZE = 100  # –í–º–µ—Å—Ç–æ 200
MAX_PREPARED_EVENTS = 20   # –í–º–µ—Å—Ç–æ 50
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ—Å—É—Ä—Å—ã —Å–µ—Ä–≤–µ—Ä–∞
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏ (–º–∏–Ω–∏–º—É–º 1GB)
- –ü—Ä–æ–≤–µ—Ä—å, –Ω–µ—Ç –ª–∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –µ–¥—è—Ç –ø–∞–º—è—Ç—å

### –®–∞–≥ 4: –†–∞—Å—Å–º–æ—Ç—Ä–∏ Redis
- –í—ã–Ω–µ—Å–∏ –∫—ç—à–∏ –≤ Redis (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
- –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–∏—Ç –ø—Ä–æ–±–ª–µ–º—É OOM

## ‚úÖ –ò—Ç–æ–≥

**–° –±–æ–ª—å—à–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é OOM –±–æ–ª—å—à–µ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–æ–∑–Ω–∏–∫–∞—Ç—å**, –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. ‚úÖ –í—Å–µ –∫—ç—à–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã
2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. ‚úÖ Memory Guard –∞–∫—Ç–∏–≤–µ–Ω
4. ‚úÖ –†–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ù–æ –µ—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç** - —ç—Ç–æ –±—É–¥–µ—Ç –≤ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö, –∏ –º—ã –º–æ–∂–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–∑–∏—Ç—å –ª–∏–º–∏—Ç—ã.

**–ú–æ–Ω–∏—Ç–æ—Ä—å –ª–æ–≥–∏ –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è!** üìä

