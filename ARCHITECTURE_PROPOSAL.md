# Архитектура новой системы заданий

## Структура категорий и подклассов

### Категория: **health** (Здоровье)

**Подклассы (place_type):**
1. `gym` - Спортзалы
2. `spa` - Спа-салоны
3. `lab` - Лаборатории
4. `clinic` - Клиники
5. `nature` - Природа (парки для активности)

**Задания для каждого подкласса:**
- gym: "Попробуй новое упражнение", "Проведи интервальную тренировку"
- spa: "Забронируй массаж", "Попробуй новую процедуру"
- lab: "Сдай анализы", "Пройди обследование"
- clinic: "Запишись на консультацию", "Пройди чекап"
- nature: "Пробежка в парке", "Йога на природе"

### Категория: **places** (Интересные места)

**Подклассы (place_type):**
1. `park` - Парки (для прогулок)
2. `exhibition` - Выставки
3. `temple` - Храмы
4. `trail` - Трекинг-тропинки

**Задания для каждого подкласса:**
- park: "Прогуляйся по парку", "Найди интересное дерево"
- exhibition: "Посети выставку", "Сфотографируй любимый экспонат"
- temple: "Посети храм", "Помедитируй 10 минут"
- trail: "Пройди тропинку", "Найди смотровую площадку"

### Категория: **food** (Еда)

**Подклассы (place_type) - предложение:**
1. `cafe` - Кафе
2. `restaurant` - Рестораны
3. `street_food` - Уличная еда
4. `market` - Рынки/фуд-корты
5. `bakery` - Пекарни/кондитерские
6. `coworking` - Коворкинг-кафе

**Задания для каждого подкласса:**
- cafe: "Попробуй кофе", "Поговори с бариста", "Найди интересный декор"
- restaurant: "Попробуй местную кухню", "Закажи новое блюдо", "Сфотографируй еду"
- street_food: "Попробуй уличную еду", "Найди новое блюдо"
- market: "Купи что-то на рынке", "Попробуй разные блюда"
- bakery: "Купи свежую выпечку", "Попробуй десерт"
- coworking: "Поработай в коворкинге", "Попробуй кофе и поработай", "Найди уютное место для работы"

## Архитектура данных

### Текущая структура:

```
task_places:
  - category: 'body' / 'spirit' → 'food' / 'health' / 'places'
  - place_type: 'cafe' / 'park' / 'gym' / ... (это и есть подклассы)
  - task_type: 'urban' / 'island'
  - region: 'moscow' / 'spb' / 'bali'
```

### Что нужно добавить:

```
task_places:
  + task_hint: VARCHAR(200) - короткое задание (1 предложение)
```

### Маппинг категорий:

```python
CATEGORY_PLACE_TYPES = {
    "food": ["cafe", "restaurant", "street_food", "market", "bakery", "coworking"],
    "health": ["gym", "spa", "lab", "clinic", "nature"],
    "places": ["park", "exhibition", "temple", "trail"],
}
```

## Логика работы

### 1. Фильтрация по категории и типу (город/остров)

```
Пользователь выбирает:
  - Категорию: food / health / places
  - Тип: urban (город) / island (остров) - определяется автоматически

Система находит места:
  - category = выбранная категория
  - task_type = urban/island (по координатам пользователя)
  - region = moscow/spb/bali (по координатам)
  - is_active = true
```

### 2. Показ списка мест

```
- 8 мест на страницу
- Сортировка: по расстоянию + ротация (не показывать 3 дня)
- Формат:
  1. Название места
  2. Расстояние + ссылка на карту
  3. Короткое задание (task_hint)
  4. Промокод (если есть)
  5. Кнопка "Добавить в квесты"
```

### 3. Короткие задания (task_hint)

**Вариант 1: Индивидуальные для каждого места**
- Каждое место имеет свою подсказку в БД
- Гибко, но нужно заполнять для каждого места

**Вариант 2: Фиксированный набор для подкласса**
- Для `cafe` есть 5 вариантов: ["Попробуй кофе", "Поговори с бариста", ...]
- Выбираем случайный для каждого показа
- Проще, но менее индивидуально

**Вариант 3: Гибридный (рекомендую)**
- Если есть индивидуальный `task_hint` в БД - используем его
- Если нет - выбираем из фиксированного набора для `place_type`

## Пример структуры в БД

```sql
-- Место с индивидуальной подсказкой
INSERT INTO task_places (category, place_type, name, task_hint, ...) VALUES
('food', 'cafe', 'Кафе на Тверской', 'Попробуй кофе, поговори с бариста', ...);

-- Место без индивидуальной подсказки (будет использоваться набор)
INSERT INTO task_places (category, place_type, name, task_hint, ...) VALUES
('food', 'cafe', 'Обычное кафе', NULL, ...);
```

## Фильтр город/остров

Уже реализовано через `task_type`:
- `urban` - для городов (Москва, СПб)
- `island` - для островов (Бали)

Определяется автоматически по координатам пользователя.

## Рекомендации

1. **Начать с простого:**
   - Добавить поле `task_hint` в `task_places`
   - Использовать фиксированные наборы подсказок для подклассов
   - Потом можно добавить индивидуальные подсказки

2. **Категория "Еда" - подклассы:**
   - cafe (кафе) ✅
   - restaurant (рестораны) ✅
   - street_food (уличная еда) - для Бали актуально
   - market (рынки) - для Бали актуально
   - bakery (пекарни) - опционально

3. **Ротация:**
   - Использовать существующую систему (3 дня не показывать)
   - Работает через `daily_views_tasks`

4. **Промокоды:**
   - Пока добавлять по мере появления
   - Показывать только если есть
