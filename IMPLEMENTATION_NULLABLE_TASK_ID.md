# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Nullable task_id (–ø–æ —Å–æ–≤–µ—Ç—É –¥—Ä—É–≥–∞)

## üéØ –¶–µ–ª—å

–£–ø—Ä–æ—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É: GPT-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–µ–±—É—é—Ç –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —à–∞–±–ª–æ–Ω—É `tasks`.

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î: `migrations/036_make_task_id_nullable.sql`

```sql
ALTER TABLE user_tasks
ALTER COLUMN task_id DROP NOT NULL;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `task_id` —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –±—ã—Ç—å `NULL` –¥–ª—è GPT-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π.

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `UserTask`

**–§–∞–π–ª:** `database.py`, —Å—Ç—Ä–æ–∫–∞ 84

```python
task_id: Mapped[int | None] = mapped_column(Integer, ForeignKey("tasks.id"), nullable=True)
```

**–ë—ã–ª–æ:** `nullable=False`  
**–°—Ç–∞–ª–æ:** `nullable=True`

### 3. –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π

**–§–∞–π–ª:** `tasks_service.py`, —Ñ—É–Ω–∫—Ü–∏—è `create_task_from_place()`

**–ò–µ—Ä–∞—Ä—Ö–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–∫–∞–∫ –≤ —Å–æ–≤–µ—Ç–µ –¥—Ä—É–≥–∞):**

1. **GPT Hint** (`place.task_hint`) - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
   - –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí `task_id = NULL`, –∏—Å–ø–æ–ª—å–∑—É–µ–º GPT-–ø–æ–¥—Å–∫–∞–∑–∫—É
   
2. **–®–∞–±–ª–æ–Ω** (`tasks`) - fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –º–µ—Å—Ç
   - –ï—Å–ª–∏ –Ω–µ—Ç GPT ‚Üí –∏—â–µ–º —à–∞–±–ª–æ–Ω –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏/—Ç–∏–ø—É
   - –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí `task_id = task.id`
   
3. **Default** - –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç
   - –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ GPT, –Ω–∏ —à–∞–±–ª–æ–Ω–∞ ‚Üí default —Ç–µ–∫—Å—Ç
   - `task_id = NULL`

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

- –£–±—Ä–∞–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ `task` –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `task_hint`
- `task_id` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω fallback
- –î–æ–±–∞–≤–ª–µ–Ω default —Ç–µ–∫—Å—Ç –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–§–∞–π–ª:** `tasks_service.py`, —Ñ—É–Ω–∫—Ü–∏—è `get_user_active_tasks()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- `JOIN Task` ‚Üí `LEFT JOIN Task` (—Ç–∞–∫ –∫–∞–∫ `task_id` –º–æ–∂–µ—Ç –±—ã—Ç—å `NULL`)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if task` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–ª–µ–π –∏–∑ `task`
- –ò–µ—Ä–∞—Ä—Ö–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏:
  1. Frozen –¥–∞–Ω–Ω—ã–µ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
  2. –®–∞–±–ª–æ–Ω (fallback)
  3. Default —Ç–µ–∫—Å—Ç

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### UserTask –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```python
{
    "id": 123,
    "user_id": 456065084,
    "task_id": None,  # NULL –¥–ª—è GPT-–∑–∞–¥–∞–Ω–∏–π
    "place_id": 102,
    "frozen_title": "–ü–æ–ø—Ä–æ–±—É–π –∫–æ—Ñ–µ, –ø–æ–≥–æ–≤–æ—Ä–∏ —Å –±–∞—Ä–∏—Å—Ç–∞",
    "frozen_description": "–ü–æ–ø—Ä–æ–±—É–π –∫–æ—Ñ–µ, –ø–æ–≥–æ–≤–æ—Ä–∏ —Å –±–∞—Ä–∏—Å—Ç–∞",
    "frozen_task_hint": "–ü–æ–ø—Ä–æ–±—É–π –∫–æ—Ñ–µ, –ø–æ–≥–æ–≤–æ—Ä–∏ —Å –±–∞—Ä–∏—Å—Ç–∞",
    "frozen_category": "food",
    # ...
}
```

## üîÑ –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã

### –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏–∑ –º–µ—Å—Ç–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ó–∞–±—Ä–∞—Ç—å –∫–≤–µ—Å—Ç" –¥–ª—è –º–µ—Å—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä—è–µ–º place.task_hint:
   ‚úÖ –ï—Å—Ç—å ‚Üí task_id = NULL, frozen = task_hint
   ‚ùå –ù–µ—Ç ‚Üí –∏—â–µ–º task –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Üí task_id = task.id, frozen = task
   ‚ùå –ù–µ—Ç –Ω–∏ —Ç–æ–≥–æ, –Ω–∏ –¥—Ä—É–≥–æ–≥–æ ‚Üí task_id = NULL, frozen = default
3. –°–æ–∑–¥–∞–µ–º UserTask —Å frozen –¥–∞–Ω–Ω—ã–º–∏
```

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è

```
1. –ó–∞–≥—Ä—É–∂–∞–µ–º UserTask (LEFT JOIN —Å Task)
2. –ü—Ä–æ–≤–µ—Ä—è–µ–º frozen –¥–∞–Ω–Ω—ã–µ:
   ‚úÖ –ï—Å—Ç—å ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º frozen (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)
   ‚ùå –ù–µ—Ç ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º task:
      ‚úÖ –ï—Å—Ç—å ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º task (fallback)
      ‚ùå –ù–µ—Ç ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º default
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** `task_id = NULL` —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ GPT-–∑–∞–¥–∞–Ω–∏–µ
2. **–ì–∏–±–∫–æ—Å—Ç—å:** –ù–µ –∑–∞–≤–∏—Å–∏–º –æ—Ç –Ω–∞–ª–∏—á–∏—è —à–∞–±–ª–æ–Ω–æ–≤ –≤ –±–∞–∑–µ
3. **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –£–±—Ä–∞–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ "—Ö–æ—Ç—å –∫–∞–∫–æ–≥–æ-–Ω–∏–±—É–¥—å task"
4. **–ß–∏—Å—Ç–æ—Ç–∞:** Frozen –¥–∞–Ω–Ω—ã–µ - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è UI

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

- –°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è —Å `task_id` –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (fallback)
- –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞–Ω–∏–π fallback —Å—Ç–∞–Ω–µ—Ç —Ä–µ–¥–∫–æ—Å—Ç—å—é
- `task_id` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏/–Ω–∞–≥—Ä–∞–¥, –Ω–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

## üìù SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å GPT-–∑–∞–¥–∞–Ω–∏—è (task_id = NULL)
SELECT id, user_id, place_id, frozen_title, task_id
FROM user_tasks
WHERE task_id IS NULL
AND status = 'active';

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–¥–∞–Ω–∏—è —Å —à–∞–±–ª–æ–Ω–∞–º–∏ (task_id != NULL)
SELECT id, user_id, place_id, frozen_title, task_id
FROM user_tasks
WHERE task_id IS NOT NULL
AND status = 'active';
```

