# üéØ –û—Ç—á—ë—Ç –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é SQL-–º–∏–≥—Ä–∞—Ü–∏–∏

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ

### 1. Workflow —Ñ–∞–π–ª
- ‚úÖ `.github/workflows/db-apply.yml` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É: `scripts/apply_sql.py`
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `sql_file` —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ–∫—Ä–µ—Ç `DATABASE_URL`

### 2. SQL –º–∏–≥—Ä–∞—Ü–∏—è
- ‚úÖ `sql/2025_ics_sources_and_indexes.sql` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –°–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `event_sources`
- ‚úÖ –°–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚úÖ –°–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É `events`

### 3. –°–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ `scripts/apply_sql.py` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç SQLAlchemy –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –ß–∏—Ç–∞–µ—Ç SQL —Ñ–∞–π–ª –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –µ–≥–æ
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏

### 4. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- ‚úÖ `requirements.txt` —Å–æ–¥–µ—Ä–∂–∏—Ç `SQLAlchemy` –∏ `psycopg2-binary`
- ‚úÖ Workflow —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### 5. –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
- ‚úÖ `test_db_connection.py` - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ `test_migration.py` - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `Makefile` —Å –Ω–æ–≤—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –ó–∞–ø—É—Å–∫ GitHub Actions
1. –û—Ç–∫—Ä–æ–π [GitHub Actions](https://github.com/krikri8k-cmd/event-bot/actions)
2. –ù–∞–π–¥–∏ workflow **"DB Apply (manual)"**
3. –ù–∞–∂–º–∏ **"Run workflow"**
4. –û—Å—Ç–∞–≤—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `sql/2025_ics_sources_and_indexes.sql`
5. –ù–∞–∂–º–∏ **"Run workflow"**

### –®–∞–≥ 2: –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```bash
# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
make test-db

# –¢–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
make test-migration
```

## üìã –ß—Ç–æ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö

```
Connecting with $DATABASE_URL
Applying 2025_ics_sources_and_indexes.sql
CREATE TABLE event_sources ...
CREATE INDEX ix_event_sources_enabled ...
CREATE INDEX ix_event_sources_region ...
CREATE INDEX ix_event_sources_next ...
ALTER TABLE events ADD COLUMN source ...
CREATE INDEX ix_events_source ...
...
Done.
```

## üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
export DATABASE_URL="postgresql://USER:PASSWORD@HOST:PORT/DB?sslmode=require"

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
make test-db

# –¢–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
make test-migration

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
make db-apply
```

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **SSL –æ—à–∏–±–∫–∏** - —É–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ URL –µ—Å—Ç—å `?sslmode=require`
2. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –≤ Railway
3. **–•–æ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** - –ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å HOST –≤ DATABASE_URL

## üìù –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

- [ ] Workflow –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å **Success**
- [ ] –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü/–∏–Ω–¥–µ–∫—Å–æ–≤
- [ ] –¢–∞–±–ª–∏—Ü–∞ `event_sources` —Å–æ–∑–¥–∞–Ω–∞ –≤ –ë–î
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

**–°—Ç–∞—Ç—É—Å**: üü¢ –ì–æ—Ç–æ–≤–æ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é

–í—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã. –ú–æ–∂–Ω–æ –ø—Ä–∏—Å—Ç—É–ø–∞—Ç—å –∫ –∑–∞–ø—É—Å–∫—É workflow –≤ GitHub Actions.
