#!/usr/bin/env python3
"""
Ğ˜Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ñ‡Ğ°Ñ‚Ğ¾Ğ² (EventAroundBot - Ğ²ĞµÑ€ÑĞ¸Ñ Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ¾Ğ²)

Ğ’ĞĞ–ĞĞ: Ğ­Ñ‚Ğ¾Ñ‚ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ¾Ñ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ°!
- Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ² group/supergroup Ñ‡Ğ°Ñ‚Ğ°Ñ…
- ĞĞ• Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ FSM ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ°
- ĞĞ• Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ¸Ğ· Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ°
- Ğ¡Ğ²ÑĞ·ÑŒ Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğ¼ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€ĞµĞ· deep-link
"""

import asyncio
import contextlib
import logging
import re
from datetime import UTC, datetime

from aiogram import Bot, F, Router, types
from aiogram.filters import Command
from aiogram.types import CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup, Message
from sqlalchemy.ext.asyncio import AsyncSession

from database import CommunityEvent
from utils.messaging_utils import delete_all_tracked, is_chat_admin

# ĞšĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´
GROUP_CMDS = [types.BotCommand(command="start", description="ğŸ‰ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ°")]
LANGS = (None, "ru", "en")  # default + ru + en


async def ensure_group_start_command(bot: Bot, chat_id: int):
    """Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /start Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ (ÑƒÑĞºĞ¾Ñ€ÑĞµÑ‚ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚)"""
    try:
        cmds = [types.BotCommand(command="start", description="ğŸ‰ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ°")]

        # Ğ”Ğ»Ñ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ¾ÑĞ¾Ğ±Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°
        chat_type = "supergroup" if str(chat_id).startswith("-100") else "group"
        logger.info(f"ğŸ”¥ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ {chat_type} {chat_id}")

        for lang in (None, "ru", "en"):
            try:
                # Ğ”Ğ»Ñ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ñ‹
                if chat_type == "supergroup":
                    # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ BotCommandScopeChat
                    try:
                        await bot.set_my_commands(
                            cmds, scope=types.BotCommandScopeChat(chat_id=chat_id), language_code=lang
                        )
                        logger.info(
                            f"âœ… ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ´Ğ»Ñ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ {chat_id} (ÑĞ·Ñ‹Ğº: {lang or 'default'})"
                        )
                    except Exception as chat_scope_error:
                        logger.warning(
                            f"âš ï¸ BotCommandScopeChat Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» Ğ´Ğ»Ñ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ {chat_id}: {chat_scope_error}"
                        )
                        # Fallback: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ AllGroupChats
                        await bot.set_my_commands(cmds, scope=types.BotCommandScopeAllGroupChats(), language_code=lang)
                        logger.info(
                            f"âœ… Fallback: ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ñ‡ĞµÑ€ĞµĞ· AllGroupChats "
                            f"Ğ´Ğ»Ñ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ {chat_id} (ÑĞ·Ñ‹Ğº: {lang or 'default'})"
                        )
                else:
                    # Ğ”Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ³Ñ€ÑƒĞ¿Ğ¿
                    await bot.set_my_commands(
                        cmds, scope=types.BotCommandScopeChat(chat_id=chat_id), language_code=lang
                    )
                    logger.info(f"âœ… ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ {chat_id} (ÑĞ·Ñ‹Ğº: {lang or 'default'})")
            except Exception as lang_error:
                logger.warning(f"âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ´Ğ»Ñ ÑĞ·Ñ‹ĞºĞ° {lang} Ğ² {chat_type} {chat_id}: {lang_error}")

        logger.info(f"âœ… ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ {chat_type} {chat_id} ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹")
    except Exception as e:
        logger.error(f"âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° ensure_group_start_command({chat_id}): {e}")


async def nudge_mobile_menu(bot: Bot, chat_id: int):
    """ĞœÑĞ³ĞºĞ¸Ğ¹ Ğ¿Ğ¸Ğ½Ğ¾Ğº Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ° - Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°"""
    try:
        msg = await bot.send_message(
            chat_id,
            "â„¹ï¸ Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹, Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ `/` Ğ¸Ğ»Ğ¸ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ `/start@EventAroundBot`.",
            disable_notification=True,
        )
        await asyncio.sleep(3)
        with contextlib.suppress(Exception):
            await bot.delete_message(chat_id, msg.message_id)
        logger.info(f"âœ… ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ° Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ {chat_id}")
    except Exception as e:
        logger.error(f"âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° nudge_mobile_menu({chat_id}): {e}")


async def restore_commands_after_hide(event_or_chat_id, bot: Bot):
    """ĞĞ°Ğ´ĞµĞ¶Ğ½Ğ¾Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°"""
    try:
        # 1) Ğ’Ñ‹Ñ‚Ğ°Ñ‰Ğ¸Ğ¼ chat_id Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾
        if isinstance(event_or_chat_id, int):
            chat_id = event_or_chat_id
            thread_id = None
        else:
            msg = event_or_chat_id if isinstance(event_or_chat_id, types.Message) else event_or_chat_id.message
            chat_id = msg.chat.id  # â† Ğ¢ĞĞ›Ğ¬ĞšĞ chat.id (Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹)
            thread_id = getattr(msg, "message_thread_id", None)

        logger.info(f"[restore] chat_id={chat_id} ({type(chat_id)}), thread_id={thread_id}")

        # 2) Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ chat_id Ğ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½ (ÑÑ‚Ñ€Ğ¾ĞºĞ° -> int)
        if isinstance(chat_id, str):
            chat_id = int(chat_id)

        # 3) Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ±Ğ¾Ñ‚ ÑĞ¾ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ² Ñ‡Ğ°Ñ‚Ğµ Ğ¸ chat_id Ğ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½
        try:
            chat = await bot.get_chat(chat_id)  # Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ BadRequest ĞµÑĞ»Ğ¸ chat_id Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½
            assert chat.type in ("supergroup", "group"), f"Unexpected chat type: {chat.type}"
            logger.info(f"[restore] Ğ§Ğ°Ñ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½: {chat.type} {chat_id}")
        except Exception as e:
            logger.error(f"[restore] ĞĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ chat_id {chat_id}: {e}")
            return

        # 4) Ğ˜Ğ½Ğ¾Ğ³Ğ´Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ Ğ½ÑƒĞ¶ĞµĞ½ Ğ¼Ğ¸Ğ»Ğ»Ğ¸ÑĞµĞºÑƒĞ½Ğ´Ğ½Ñ‹Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ
        await asyncio.sleep(0.5)

        # 5) Ğ’ĞµÑ€Ğ½Ñ‘Ğ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±Ğ¾Ñ‚Ğ°" Ğ¸ /start Ğ¡ĞŸĞ•Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°
        for lang in LANGS:
            try:
                await bot.set_my_commands(
                    GROUP_CMDS, scope=types.BotCommandScopeChat(chat_id=chat_id), language_code=lang
                )
                logger.info(f"[restore] ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ğ´Ğ»Ñ ÑĞ·Ñ‹ĞºĞ° {lang or 'default'}")
            except Exception as e:
                logger.error(f"[restore] ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ´Ğ»Ñ ÑĞ·Ñ‹ĞºĞ° {lang}: {e}")

        await bot.set_chat_menu_button(chat_id=chat_id, menu_button=types.MenuButtonCommands())
        logger.info(f"[restore] Menu Button ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {chat_id}")

        # 6) ĞŸĞ¾Ğ´ÑÑ‚Ñ€Ğ°Ñ…Ğ¾Ğ²ĞºĞ°: Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ Ñ‡ĞµÑ€ĞµĞ· 2 ÑĞµĞº (Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºÑÑˆ Telegram)
        await asyncio.sleep(2)
        for lang in LANGS:
            try:
                await bot.set_my_commands(
                    GROUP_CMDS, scope=types.BotCommandScopeChat(chat_id=chat_id), language_code=lang
                )
            except Exception as e:
                logger.error(f"[restore] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ´Ğ»Ñ ÑĞ·Ñ‹ĞºĞ° {lang}: {e}")

        logger.info(f"[restore] /start Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}")

    except Exception as e:
        logger.error(f"[restore] ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´: {e}")


logger = logging.getLogger(__name__)


# === Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« ===


def extract_city_from_location_url(location_url: str) -> str | None:
    """Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ³Ğ¾Ñ€Ğ¾Ğ´ Ğ¸Ğ· Google Maps ÑÑÑ‹Ğ»ĞºĞ¸ Ğ¸Ğ»Ğ¸ Ğ°Ğ´Ñ€ĞµÑĞ°"""
    if not location_url:
        return None

    # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ñ… Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ¾Ğ²/Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ
    known_cities = [
        # Ğ‘Ğ°Ğ»Ğ¸
        "Canggu",
        "Seminyak",
        "Ubud",
        "Sanur",
        "Kuta",
        "Denpasar",
        "Uluwatu",
        "Nusa Dua",
        # Ğ’ÑŒĞµÑ‚Ğ½Ğ°Ğ¼
        "Nha Trang",
        "Ho Chi Minh",
        "Hanoi",
        "Da Nang",
        "Hoi An",
        "Phu Quoc",
        # Ğ Ğ¾ÑÑĞ¸Ñ
        "Moscow",
        "Saint Petersburg",
        "SPB",
        "Novosibirsk",
        "Yekaterinburg",
        # Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ
        "Bangkok",
        "Phuket",
        "Chiang Mai",
        "Jakarta",
        "Bali",
        "Singapore",
    ]

    # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ñ‰ĞµĞ¼ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°
    for city in known_cities:
        if city.lower() in location_url.lower():
            return city

    # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°ÑˆĞ»Ğ¸ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ğ¿Ğ¾ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ°Ğ¼
    patterns = [
        # Google Maps URL Ñ Ğ°Ğ´Ñ€ĞµÑĞ¾Ğ¼: "Street, City, Region, Country"
        r",\s*([A-Za-z\s]+),\s*[A-Za-z\s]+,\s*[A-Za-z\s]+$",  # ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ¿ĞµÑ€ĞµĞ´ ÑÑ‚Ñ€Ğ°Ğ½Ğ¾Ğ¹
        r",\s*([A-Za-z\s]+),\s*\d{5}",  # Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ğ¾Ñ‡Ñ‚Ğ¾Ğ²Ñ‹Ğ¼ Ğ¸Ğ½Ğ´ĞµĞºÑĞ¾Ğ¼
        r",\s*([A-Za-z\s]+),\s*[A-Z]{2}\s*\d{5}",  # Ğ“Ğ¾Ñ€Ğ¾Ğ´, ÑˆÑ‚Ğ°Ñ‚, Ğ¿Ğ¾Ñ‡Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ½Ğ´ĞµĞºÑ
    ]

    for pattern in patterns:
        match = re.search(pattern, location_url, re.IGNORECASE)
        if match:
            city = match.group(1).strip()
            # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¾Ñ‚ Ğ»Ğ¸ÑˆĞ½Ğ¸Ñ… ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² Ğ¸ Ñ†Ğ¸Ñ„Ñ€
            city = re.sub(r"[^\w\s-]", "", city).strip()
            city = re.sub(r"\d+", "", city).strip()  # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ†Ğ¸Ñ„Ñ€Ñ‹
            if city and len(city) > 2:  # ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ° Ğ´Ğ»Ñ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°
                return city

    return None


# === ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ ===

# Username Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ deep-links (Ğ±ÑƒĞ´ĞµÑ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¿Ñ€Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸)
MAIN_BOT_USERNAME = None  # Ğ‘ÑƒĞ´ĞµÑ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ² set_bot_username()

# === Ğ ĞĞ£Ğ¢Ğ•Ğ  ===

group_router = Router(name="group_router")


@group_router.message(lambda message: message.text == "/test_autodelete")
async def test_autodelete(message: Message, bot: Bot, session: AsyncSession):
    """Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ"""
    if message.chat.type in ("group", "supergroup"):
        logger.info(f"ğŸ§ª Ğ¢ĞµÑÑ‚ Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {message.from_user.id} Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}")

        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ñ‡ĞµÑ€ĞµĞ· 10 ÑĞµĞºÑƒĞ½Ğ´
        from utils.messaging_utils import send_tracked

        test_msg = await send_tracked(
            bot,
            session,
            chat_id=message.chat.id,
            text="ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ - Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒÑÑ Ñ‡ĞµÑ€ĞµĞ· 10 ÑĞµĞºÑƒĞ½Ğ´",
            tag="service",
        )

        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· 10 ÑĞµĞºÑƒĞ½Ğ´ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ°
        import asyncio

        from utils.messaging_utils import auto_delete_message

        asyncio.create_task(auto_delete_message(bot, message.chat.id, test_msg.message_id, 10))

        await message.answer("âœ… Ğ¢ĞµÑÑ‚ Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½! Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· 10 ÑĞµĞºÑƒĞ½Ğ´.")


@group_router.message(Command("start"))
async def handle_start_command(message: Message, bot: Bot, session: AsyncSession):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ… Ğ¸ ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ñ… - Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Community"""
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ñ‡Ğ°Ñ‚Ğ° - Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹, ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¸ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹
    if message.chat.type not in ("group", "supergroup", "channel"):
        logger.warning(f"âš ï¸ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start Ğ¸Ğ· Ğ½ĞµĞ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ğ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ° Ñ‡Ğ°Ñ‚Ğ° '{message.chat.type}' (ID: {message.chat.id})")
        return

    logger.info(
        f"ğŸ”¥ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {message.from_user.id} Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id} (Ñ‚Ğ¸Ğ¿: {message.chat.type})"
    )

    # Ğ”Ğ»Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² - Ğ¾ÑĞ¾Ğ±Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° (Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ñ… Ğ±Ğ¾Ñ‚Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ÑÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹)
    is_channel = message.chat.type == "channel"

    # Ğ˜Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞµÑÑĞ¸Ñ Community (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, Ğ½Ğµ Ğ´Ğ»Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²)
    if not is_channel:
        try:
            from utils.user_analytics import UserAnalytics

            UserAnalytics.increment_sessions_community(message.from_user.id)
        except Exception as e:
            logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ Community: {e}")

    # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /start Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ…, Ğ½Ğµ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ñ…)
    if not is_channel:
        # Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¿Ñ‹Ñ‚Ğ°ĞµĞ¼ÑÑ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        # Ğ’ Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ°Ñ… ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ¶Ğµ Ğ² Ğ¾Ğ±Ñ‰ĞµĞ¼ Ñ‡Ğ°Ñ‚Ğµ
        try:
            await message.delete()
            logger.info(
                f"âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° {message.text} Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {message.from_user.id} Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}"
            )
        except Exception as e:
            error_str = str(e).lower()
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ - ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸
            if (
                "message to delete not found" in error_str
                or "can't delete message" in error_str
                or "ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ" in error_str
            ):
                # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ°Ğº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, Ğ½Ğµ ĞºĞ°Ğº Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ
                is_forum = getattr(message.chat, "is_forum", False)
                thread_id = getattr(message, "message_thread_id", None)
                if is_forum and thread_id is None:
                    logger.info(
                        f"â„¹ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ {message.text} Ğ² Ñ„Ğ¾Ñ€ÑƒĞ¼Ğµ Ğ²Ğ½Ğµ Ñ‚ĞµĞ¼Ñ‹ "
                        f"(chat_id={message.chat.id}, thread_id=None) - ÑÑ‚Ğ¾ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Telegram API"
                    )
                else:
                    logger.info(
                        f"â„¹ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ {message.text} Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id} "
                        "(Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ¶Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾)"
                    )
            else:
                # Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ - Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ°Ğº Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ
                logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ {message.text}: {e}")

    # Ğ¡Ğ¢ĞĞ ĞĞ– ĞšĞĞœĞĞĞ”: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¿Ñ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ /start Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ
    try:
        from bot_enhanced_v3 import ensure_commands

        await ensure_commands(bot)
        logger.info(f"âœ… Ğ¡Ñ‚Ğ¾Ñ€Ğ¾Ğ¶ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ Ğ¿Ñ€Ğ¸ /start Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ {message.chat.id}")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ¿Ñ€Ğ¸ /start Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ {message.chat.id}: {e}")

    # Ğ›ĞĞ“Ğ˜Ğ Ğ£Ğ•Ğœ Ğ˜ĞĞ¤ĞĞ ĞœĞĞ¦Ğ˜Ğ® Ğ Ğ§ĞĞ¢Ğ•
    is_forum = message.chat.type == "supergroup"
    thread_id = getattr(message, "message_thread_id", None)
    logger.info(f"ğŸ”¥ /start Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ: chat_id={message.chat.id}, is_forum={is_forum}, thread_id={thread_id}")

    # Ğ£Ğ¡Ğ¢ĞĞĞĞ’Ğ›Ğ˜Ğ’ĞĞ•Ğœ ĞšĞĞœĞĞĞ”Ğ« Ğ”Ğ›Ğ¯ ĞšĞĞĞšĞ Ğ•Ğ¢ĞĞĞ™ Ğ“Ğ Ğ£ĞŸĞŸĞ«
    await ensure_group_start_command(bot, message.chat.id)

    # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹

    # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Community Ñ InlineKeyboard Ğ¿Ğ¾Ğ´ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼
    try:
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ InlineKeyboard Ğ´Ğ»Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¿Ğ¾Ğ´ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [
                    InlineKeyboardButton(
                        text="â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ", url=f"https://t.me/EventAroundBot?start=group_{message.chat.id}"
                    )
                ],
                [InlineKeyboardButton(text="ğŸ“‹ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°", callback_data="group_list")],
                [InlineKeyboardButton(text='ğŸš€ Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ "World"', url="https://t.me/EventAroundBot")],
                [InlineKeyboardButton(text="ğŸ‘ï¸â€ğŸ—¨ï¸ Ğ¡Ğ¿Ñ€ÑÑ‚Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°", callback_data="group_hide_execute")],
            ]
        )

        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Community Ñ Ñ‚Ñ€ĞµĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ (Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· 4 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹)
        try:
            from utils.messaging_utils import send_tracked

            panel_text = (
                'ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ EventAroundBot - Ğ²ĞµÑ€ÑĞ¸Ñ "Community".\n\n'
                "ğŸ¯ Ğ§Ñ‚Ğ¾ ÑƒĞ¼ĞµÑ:\n\n"
                "â€¢ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ñ‡Ğ°Ñ‚Ğ°\n"
                "â€¢ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°\n"
                'â€¢ ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ² Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚ - Ğ²ĞµÑ€ÑĞ¸Ñ "World"\n\n'
                "ğŸ’¡ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:"
            )

            # ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ message_thread_id Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ¾Ğ²
            send_kwargs = {"reply_markup": keyboard}
            if is_forum and thread_id:
                send_kwargs["message_thread_id"] = thread_id

            await send_tracked(
                bot,
                session,
                chat_id=message.chat.id,
                text=panel_text,
                tag="panel",  # Ğ¢ĞµĞ³ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· 4 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹
                **send_kwargs,
            )
            logger.info(f"âœ… ĞŸĞ°Ğ½ĞµĞ»ÑŒ Community Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¸ Ñ‚Ñ€ĞµĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}")
        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° send_tracked: {e}")
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ»Ğ¸ Ñ‚ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ°
            if "TOPIC_CLOSED" in str(e):
                logger.warning(
                    f"âš ï¸ Ğ¢ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}. "
                    "Ğ‘Ğ¾Ñ‚ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ñ‚ĞµĞ¼Ñ‹."
                )
                return
            # Fallback - Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ±ĞµĞ· Ñ‚Ñ€ĞµĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            try:
                await message.answer(
                    'ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ EventAroundBot - Ğ²ĞµÑ€ÑĞ¸Ñ "Community".\n\n'
                    "ğŸ¯ Ğ§Ñ‚Ğ¾ ÑƒĞ¼ĞµÑ:\n\n"
                    "â€¢ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ñ‡Ğ°Ñ‚Ğ°\n"
                    "â€¢ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°\n"
                    'â€¢ ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ² Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚ - Ğ²ĞµÑ€ÑĞ¸Ñ "World"\n\n'
                    "ğŸ’¡ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
                    reply_markup=keyboard,
                    parse_mode="Markdown",
                )
            except Exception as fallback_error:
                if "TOPIC_CLOSED" in str(fallback_error):
                    logger.warning(
                        f"âš ï¸ Ğ¢ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}. "
                        "Ğ‘Ğ¾Ñ‚ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ñ‚ĞµĞ¼Ñ‹."
                    )
                    return
                raise

        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ ReplyKeyboard Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ…, Ğ½Ğµ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ñ…)
        if not is_channel:
            from aiogram.types import KeyboardButton, ReplyKeyboardMarkup

            start_keyboard = ReplyKeyboardMarkup(
                keyboard=[[KeyboardButton(text="/start@EventAroundBot ğŸ‰")]],
                resize_keyboard=True,
                one_time_keyboard=False,
                persistent=True,
            )

            try:
                # Ğ”Ğ»Ñ Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ¾Ğ² Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ message_thread_id
                answer_kwargs = {"reply_markup": start_keyboard}
                if is_forum and thread_id:
                    answer_kwargs["message_thread_id"] = thread_id
                activation_msg = await message.answer("ğŸ¤– EventAroundBot Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½!", **answer_kwargs)
            except Exception as e:
                if "TOPIC_CLOSED" in str(e):
                    logger.warning(
                        f"âš ï¸ Ğ¢ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}. "
                        "Ğ‘Ğ¾Ñ‚ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ñ‚ĞµĞ¼Ñ‹."
                    )
                    return
                raise

            # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· 1 ÑĞµĞºÑƒĞ½Ğ´Ñƒ (ReplyKeyboard Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ)
            try:
                await asyncio.sleep(1)
                await bot.delete_message(message.chat.id, activation_msg.message_id)
                logger.info(f"âœ… Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾, ReplyKeyboard Ğ¾ÑÑ‚Ğ°Ğ»ÑÑ Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}")
            except Exception as e:
                logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸: {e}")

            # ĞŸĞ Ğ˜ĞĞ£Ğ”Ğ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ…: ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¸ Ğ¼ĞµĞ½Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ…)
            try:
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ñ‡Ğ°Ñ‚ Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ¾Ğ¼
                # Ğ”Ğ»Ñ Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ¾Ğ² Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ BotCommandScopeChat
                is_forum_check = getattr(message.chat, "is_forum", False)
                if is_forum_check:
                    logger.info(
                        f"â„¹ï¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ° "
                        f"(Ñ„Ğ¾Ñ€ÑƒĞ¼ {message.chat.id} - ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑƒĞ¶Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ñ‡ĞµÑ€ĞµĞ· BotCommandScopeAllGroupChats)"
                    )
                else:
                    # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ½Ğµ-Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ¾Ğ²)
                    await bot.set_my_commands(
                        [types.BotCommand(command="start", description="ğŸ‰ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ°")],
                        scope=types.BotCommandScopeChat(chat_id=message.chat.id),
                    )

                # Ğ’ĞĞ–ĞĞ: Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ MenuButton Ğ´Ğ»Ñ Ğ’Ğ¡Ğ•Ğ¥ Ñ‚Ğ¸Ğ¿Ğ¾Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿ (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ñ„Ğ¾Ñ€ÑƒĞ¼Ñ‹)
                # Ğ­Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±Ğ¾Ñ‚Ğ°" Ğ½Ğ° Ğ²ÑĞµÑ… ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°Ñ…, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ MacBook
                # Ğ”Ğ»Ñ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ chat_id, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¾Ğ±Ğ° Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ°
                try:
                    # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°
                    await bot.set_chat_menu_button(chat_id=message.chat.id, menu_button=types.MenuButtonCommands())
                    logger.info(
                        f"âœ… MenuButton ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id} "
                        f"(Ñ‚Ğ¸Ğ¿: {message.chat.type}, Ñ„Ğ¾Ñ€ÑƒĞ¼: {is_forum_check})"
                    )
                except Exception as menu_error:
                    error_str = str(menu_error).lower()
                    # Ğ•ÑĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞ²ÑĞ·Ğ°Ğ½Ğ° Ñ chat_id, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
                    if "chat_id" in error_str or "Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹" in error_str or "invalid" in error_str:
                        logger.warning(
                            f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ MenuButton Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}, "
                            f"Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾: {menu_error}"
                        )
                        try:
                            # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ³Ñ€ÑƒĞ¿Ğ¿
                            await bot.set_chat_menu_button(menu_button=types.MenuButtonCommands())
                            logger.info("âœ… MenuButton ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ³Ñ€ÑƒĞ¿Ğ¿")
                        except Exception as global_error:
                            logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ MenuButton Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾: {global_error}")
                    else:
                        logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ MenuButton Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}: {menu_error}")

                logger.info(f"âœ… ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¸ Ğ¼ĞµĞ½Ñ Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}")

            except Exception as e:
                logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ…: {e}")
        else:
            # Ğ”Ğ»Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² - Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ÑƒÑĞ¿ĞµÑ…
            logger.info(f"âœ… ĞŸĞ°Ğ½ĞµĞ»ÑŒ Community Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ² ĞºĞ°Ğ½Ğ°Ğ» {message.chat.id}")

    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Community: {e}")
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ»Ğ¸ Ñ‚ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ°
        if "TOPIC_CLOSED" in str(e):
            logger.warning(
                f"âš ï¸ Ğ¢ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}. " "Ğ‘Ğ¾Ñ‚ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ñ‚ĞµĞ¼Ñ‹."
            )
            return
        try:
            fallback_msg = await message.answer("ğŸ¤– EventAroundBot Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğµ!")
            # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ fallback ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· 3 ÑĞµĞºÑƒĞ½Ğ´Ñ‹
            try:
                await asyncio.sleep(3)
                await bot.delete_message(message.chat.id, fallback_msg.message_id)
                logger.info(f"âœ… Fallback ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}")
            except Exception as delete_error:
                logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ fallback ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸: {delete_error}")
        except Exception as fallback_error:
            if "TOPIC_CLOSED" in str(fallback_error):
                logger.warning(
                    f"âš ï¸ Ğ¢ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}. "
                    "Ğ‘Ğ¾Ñ‚ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ñ‚ĞµĞ¼Ñ‹."
                )
                return
            raise


# Ğ£Ğ±Ñ€Ğ°Ğ½Ñ‹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ReplyKeyboard ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº - Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ InlineKeyboard


# === Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ===


def set_bot_username(username: str):
    """Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ username Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ deep-links"""
    global MAIN_BOT_USERNAME
    MAIN_BOT_USERNAME = username
    logger.info(f"âœ… Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ username Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ğ°: {username}")


async def setup_group_menu_button(bot, group_id: int = None):
    """ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Menu Button Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ñ‡Ğ°Ñ‚Ğ¾Ğ² Ñ Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¾Ğ¹"""
    try:
        from aiogram.types import BotCommand, BotCommandScopeAllGroupChats, MenuButtonCommands

        # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿
        group_commands = [
            BotCommand(command="start", description="ğŸ‰ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ°"),
        ]

        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿ (Ğ±ĞµĞ· ÑĞ·Ñ‹ĞºĞ° Ğ¸ Ñ Ñ€ÑƒÑÑĞºĞ¾Ğ¹ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒÑ)
        await bot.set_my_commands(group_commands, scope=BotCommandScopeAllGroupChats())
        await bot.set_my_commands(group_commands, scope=BotCommandScopeAllGroupChats(), language_code="ru")

        # ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´
        import asyncio

        await asyncio.sleep(1)

        # ĞŸĞ Ğ˜ĞĞ£Ğ”Ğ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞĞ¯ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Menu Button Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿
        try:
            # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Menu Button
            current_button = await bot.get_chat_menu_button()
            logger.info(f"ğŸ” Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Menu Button Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿: {current_button}")

            # Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ WebApp, ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° Default, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ½Ğ° Commands
            if hasattr(current_button, "type") and current_button.type == "web_app":
                logger.warning("âš ï¸ Menu Button Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚ WebApp! Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼...")
                from aiogram.types import MenuButtonDefault

                await bot.set_chat_menu_button(menu_button=MenuButtonDefault())
                await asyncio.sleep(1)

            # ĞŸĞ Ğ˜ĞĞ£Ğ”Ğ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Commands Ğ´Ğ»Ñ Ğ’Ğ¡Ğ•Ğ¥ Ğ³Ñ€ÑƒĞ¿Ğ¿
            await bot.set_chat_menu_button(menu_button=MenuButtonCommands())
            logger.info("âœ… Menu Button Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ³Ñ€ÑƒĞ¿Ğ¿")

            # Ğ•ÑĞ»Ğ¸ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ° ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ°Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° - Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ´Ğ»Ñ Ğ½ĞµÑ‘
            if group_id:
                await bot.set_chat_menu_button(chat_id=group_id, menu_button=MenuButtonCommands())
                logger.info(f"âœ… Menu Button Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ {group_id}")

        except Exception as e:
            logger.warning(f"âš ï¸ Menu Button Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ: {e}")

        logger.info("âœ… Menu Button Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ñ‡Ğ°Ñ‚Ğ¾Ğ²")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Menu Button Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿: {e}")


# Ğ£Ğ‘Ğ ĞĞĞ: Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Reply Keyboard - Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¸ Ğ¼ĞµĞ½Ñ


# Ğ–Ñ‘ÑÑ‚ĞºĞ°Ñ Ğ¸Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ: Ñ€Ğ¾ÑƒÑ‚ĞµÑ€ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ…
group_router.message.filter(F.chat.type.in_({"group", "supergroup"}))
group_router.callback_query.filter(F.message.chat.type.in_({"group", "supergroup"}))


# ĞŸĞ Ğ˜ĞĞ£Ğ”Ğ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞĞ¯ ĞšĞ›ĞĞ’Ğ˜ĞĞ¢Ğ£Ğ Ğ Ğ”Ğ›Ğ¯ Ğ’Ğ¡Ğ•Ğ¥ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™ Ğ’ Ğ“Ğ Ğ£ĞŸĞŸĞ•
# Ğ£Ğ‘Ğ ĞĞĞ: force_keyboard_for_all_messages - Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğº ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼Ñƒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ


# === Ğ¢Ğ•ĞšĞ¡Ğ¢Ğ« Ğ˜ ĞšĞ›ĞĞ’Ğ˜ĞĞ¢Ğ£Ğ Ğ« ===

PANEL_TEXT = (
    'ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ EventAroundBot - Ğ²ĞµÑ€ÑĞ¸Ñ "Community".\n\n'
    "ğŸ¯ Ğ§Ñ‚Ğ¾ ÑƒĞ¼ĞµÑ:\n"
    "â€¢ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ñ‡Ğ°Ñ‚Ğ°\n"
    "â€¢ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°\n"
    'â€¢ ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ² Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚ - Ğ²ĞµÑ€ÑĞ¸Ñ "World"\n\n'
    "ğŸ’¡ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:"
)


def group_kb(chat_id: int) -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°"""
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ username Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ", url=f"https://t.me/EventAroundBot?start=group_{chat_id}")],
            [InlineKeyboardButton(text="ğŸ“‹ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°", callback_data="group_list")],
            [InlineKeyboardButton(text='ğŸš€ Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ "World"', url="https://t.me/EventAroundBot")],
            [InlineKeyboardButton(text="ğŸ‘ï¸â€ğŸ—¨ï¸ Ğ¡Ğ¿Ñ€ÑÑ‚Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°", callback_data="group_hide_execute")],
        ]
    )


# === ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ ===


# Ğ£Ğ‘Ğ ĞĞĞ: Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº Reply Keyboard - Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ±Ğ¾Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€ĞµĞ· ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¸ Ğ¼ĞµĞ½Ñ


# ĞŸĞ Ğ˜ĞĞ£Ğ”Ğ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞĞ¯ ĞšĞ›ĞĞ’Ğ˜ĞĞ¢Ğ£Ğ Ğ ĞŸĞ Ğ˜ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ˜Ğ˜ Ğ‘ĞĞ¢Ğ Ğ’ Ğ“Ğ Ğ£ĞŸĞŸĞ£ Ğ˜Ğ›Ğ˜ ĞšĞĞĞĞ›
@group_router.message(F.new_chat_members, F.chat.type.in_({"group", "supergroup", "channel"}))
async def handle_new_members(message: Message, bot: Bot, session: AsyncSession):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ Ğ¸Ğ»Ğ¸ ĞºĞ°Ğ½Ğ°Ğ»"""
    logger.info(
        f"ğŸ”¥ handle_new_members: Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ new_chat_members Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id} (Ñ‚Ğ¸Ğ¿: {message.chat.type})"
    )

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ½Ğ°ÑˆĞµĞ¼ Ğ±Ğ¾Ñ‚Ğµ
    bot_info = await bot.get_me()
    logger.info(f"ğŸ”¥ ĞĞ°Ñˆ Ğ±Ğ¾Ñ‚ ID: {bot_info.id}, username: {bot_info.username}")

    # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞµÑ… Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
    for member in message.new_chat_members:
        logger.info(f"ğŸ”¥ ĞĞ¾Ğ²Ñ‹Ğ¹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº: id={member.id}, is_bot={member.is_bot}, username={member.username}")

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ¸ Ğ»Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ½Ğ°ÑˆĞµĞ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ° (Ğ¿Ğ¾ ID)
    bot_added = any(member.id == bot_info.id and member.is_bot for member in message.new_chat_members)

    if bot_added:
        chat_type_name = "ĞºĞ°Ğ½Ğ°Ğ»" if message.chat.type == "channel" else "Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ"
        logger.info(f"âœ… ĞĞ°Ñˆ Ğ±Ğ¾Ñ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² {chat_type_name} {message.chat.id} (Ñ‚Ğ¸Ğ¿: {message.chat.type})")

        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² chat_settings ÑÑ€Ğ°Ğ·Ñƒ
        import json

        from sqlalchemy import select, text

        from database import ChatSettings

        try:
            result = await session.execute(select(ChatSettings).where(ChatSettings.chat_id == message.chat.id))
            settings = result.scalar_one_or_none()

            if not settings:
                logger.info(f"ğŸ”¥ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² chat_settings Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}")
                # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ chat_number
                result = await session.execute(text("SELECT nextval('chat_number_seq')"))
                chat_number = result.scalar()
                logger.info(f"âœ… ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ chat_number={chat_number} Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}")

                # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
                admin_ids = []
                admin_count = 0
                try:
                    from utils.community_events_service import CommunityEventsService

                    community_service = CommunityEventsService()
                    admin_ids = await community_service.get_cached_admin_ids(bot, message.chat.id)
                    admin_count = len(admin_ids)
                    logger.info(f"âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}: count={admin_count}")
                except Exception as e:
                    logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ² Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}: {e}")

                settings = ChatSettings(
                    chat_id=message.chat.id,
                    chat_number=chat_number,
                    admin_ids=json.dumps(admin_ids) if admin_ids else None,
                    admin_count=admin_count,
                    bot_status="active",
                    total_events=0,  # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
                )
                session.add(settings)
                await session.commit()
                logger.info(f"âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ chat_settings ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}, chat_number={chat_number}")
            else:
                logger.info(f"ğŸ”¥ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ chat_settings ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}, Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ")
                # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¼ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸
                settings.bot_status = "active"
                settings.bot_removed_at = None

                # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²
                try:
                    from utils.community_events_service import CommunityEventsService

                    community_service = CommunityEventsService()
                    admin_ids = await community_service.get_cached_admin_ids(bot, message.chat.id)
                    admin_count = len(admin_ids)
                    settings.admin_ids = json.dumps(admin_ids) if admin_ids else None
                    settings.admin_count = admin_count
                    logger.info(f"âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñ‹ Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}: count={admin_count}")
                except Exception as e:
                    logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ² Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}: {e}")

                await session.commit()
                logger.info(f"âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ chat_settings Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}")

            # ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ±ĞµĞ· Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ²ĞµÑ‚ĞºĞ¸ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ…, Ğ½Ğµ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ñ…)
            if message.chat.type != "channel":
                # Ğ’ĞĞ–ĞĞ: Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ MenuButton Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ±Ğ¾Ñ‚Ğ° Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ
                # Ğ­Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±Ğ¾Ñ‚Ğ°" Ğ½Ğ° Ğ²ÑĞµÑ… ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°Ñ…, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ MacBook
                # Ğ”Ğ»Ñ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ chat_id, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¾Ğ±Ğ° Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ°
                try:
                    # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°
                    await bot.set_chat_menu_button(chat_id=message.chat.id, menu_button=types.MenuButtonCommands())
                    logger.info(f"âœ… MenuButton ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ±Ğ¾Ñ‚Ğ° Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ {message.chat.id}")
                except Exception as menu_error:
                    error_str = str(menu_error).lower()
                    # Ğ•ÑĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞ²ÑĞ·Ğ°Ğ½Ğ° Ñ chat_id, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
                    if "chat_id" in error_str or "Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹" in error_str or "invalid" in error_str:
                        logger.warning(
                            f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ MenuButton Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id} "
                            f"Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾: {menu_error}"
                        )
                        try:
                            # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ³Ñ€ÑƒĞ¿Ğ¿
                            await bot.set_chat_menu_button(menu_button=types.MenuButtonCommands())
                            logger.info("âœ… MenuButton ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ±Ğ¾Ñ‚Ğ°")
                        except Exception as global_error:
                            logger.warning(
                                f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ MenuButton Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸: {global_error}"
                            )
                    else:
                        logger.warning(
                            f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ MenuButton Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ "
                            f"Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ {message.chat.id}: {menu_error}"
                        )

                # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°
                try:
                    await bot.set_my_commands(
                        [types.BotCommand(command="start", description="ğŸ‰ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ°")],
                        scope=types.BotCommandScopeChat(chat_id=message.chat.id),
                    )
                    logger.info(f"âœ… ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ±Ğ¾Ñ‚Ğ° Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ {message.chat.id}")
                except Exception as cmd_error:
                    logger.warning(
                        f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ {message.chat.id}: {cmd_error}"
                    )

                try:
                    await message.answer(
                        "ğŸ‰ **Ğ‘Ğ¾Ñ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ!**\n\n" "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /start Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹",
                        parse_mode="Markdown",
                    )
                except Exception as answer_error:
                    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ»Ğ¸ Ñ‚ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ°
                    if "TOPIC_CLOSED" in str(answer_error):
                        logger.warning(
                            f"âš ï¸ Ğ¢ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}. "
                            "Ğ‘Ğ¾Ñ‚ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ÑƒÑ Ñ‚ĞµĞ¼Ñƒ."
                        )
                    else:
                        logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: {answer_error}")
            else:
                # Ğ”Ğ»Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² - Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ±Ğ¾Ñ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ
                logger.info(f"âœ… Ğ‘Ğ¾Ñ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğµ {message.chat.id}. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /start Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹")
        except Exception as e:
            error_str = str(e)
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ»Ğ¸ Ñ‚ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ°
            if "TOPIC_CLOSED" in error_str:
                logger.warning(
                    f"âš ï¸ Ğ¢ĞµĞ¼Ğ° Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}. "
                    "Ğ‘Ğ¾Ñ‚ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ÑƒÑ Ñ‚ĞµĞ¼Ñƒ."
                )
            else:
                logger.error(
                    f"âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ chat_settings Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {message.chat.id}: {e}", exc_info=True
                )
            # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ¸Ñ‚ÑŒ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ
            try:
                await session.rollback()
            except Exception as rollback_error:
                logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸: {rollback_error}")
    else:
        logger.info(f"â„¹ï¸ Ğ’ Ñ‡Ğ°Ñ‚ {message.chat.id} Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ½Ğµ Ğ½Ğ°Ñˆ Ğ±Ğ¾Ñ‚ Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ±Ğ¾Ñ‚ Ğ²Ğ¾Ğ¾Ğ±Ñ‰Ğµ")


@group_router.callback_query(F.data == "group_list")
async def group_list_events(callback: CallbackQuery, bot: Bot, session: AsyncSession):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ° (Ğ¿ĞµÑ€Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°)"""
    await group_list_events_page(callback, bot, session, page=1)


@group_router.callback_query(F.data.startswith("group_list_page_"))
async def group_list_events_page_handler(callback: CallbackQuery, bot: Bot, session: AsyncSession):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°Ğ¼ ÑĞ¿Ğ¸ÑĞºĞ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹"""
    try:
        page = int(callback.data.split("_")[-1])
    except (ValueError, IndexError):
        page = 1
    await group_list_events_page(callback, bot, session, page)


async def group_list_events_page(callback: CallbackQuery, bot: Bot, session: AsyncSession, page: int = 1):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ° Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹"""
    chat_id = callback.message.chat.id
    user_id = callback.from_user.id
    events_per_page = 10

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ thread_id Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ¾Ğ²
    is_forum = getattr(callback.message.chat, "is_forum", False)
    thread_id = getattr(callback.message, "message_thread_id", None)

    logger.info(
        f"ğŸ”¥ group_list_events_page: Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ¿Ğ¸ÑĞºĞ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}, ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {page}, thread_id={thread_id}"
    )

    await callback.answer()  # Ğ¢Ğ¾ÑÑ‚, Ğ½Ğµ ÑĞ¿Ğ°Ğ¼Ğ¸Ğ¼

    try:
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°

        from sqlalchemy import func, select

        # Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ’Ğ¡Ğ• Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (Ğ´Ğ°Ğ¶Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ½ĞµĞ´ĞµĞ»Ñ Ğ¸Ğ»Ğ¸ Ğ³Ğ¾Ğ´),
        # Ğ½Ğ¾ ĞĞ• Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑˆĞµĞ´ÑˆĞ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (starts_at >= NOW())
        # Ğ­Ñ‚Ğ¾ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚, Ñ‡Ñ‚Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ, Ñƒ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ´ĞµĞ½ÑŒ ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¾ÑˆĞµĞ», Ğ½Ğµ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ÑÑ
        now_utc = datetime.now(UTC)

        # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
        count_stmt = select(func.count(CommunityEvent.id)).where(
            CommunityEvent.chat_id == chat_id,
            CommunityEvent.status == "open",
            CommunityEvent.starts_at >= now_utc,  # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ, Ğ±ĞµĞ· Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
        )
        total_result = await session.execute(count_stmt)
        total_events = total_result.scalar() or 0

        # Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ offset Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
        offset = (page - 1) * events_per_page
        total_pages = (total_events + events_per_page - 1) // events_per_page if total_events > 0 else 1

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
        stmt = (
            select(CommunityEvent)
            .where(
                CommunityEvent.chat_id == chat_id,
                CommunityEvent.status == "open",
                CommunityEvent.starts_at >= now_utc,  # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ, Ğ±ĞµĞ· Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
            )
            .order_by(CommunityEvent.starts_at)
            .offset(offset)
            .limit(events_per_page)
        )

        result = await session.execute(stmt)
        events = result.scalars().all()

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ¼ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
        is_admin = await is_chat_admin(bot, chat_id, callback.from_user.id)

        if not events:
            text = (
                "ğŸ“‹ **Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°**\n\n"
                "ğŸ“­ **0 ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹**\n\n"
                "Ğ’ ÑÑ‚Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğµ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹.\n\n"
                "ğŸ’¡ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ, Ğ½Ğ°Ğ¶Ğ°Ğ² ĞºĞ½Ğ¾Ğ¿ĞºÑƒ **â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ**!"
            )
        else:
            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸
            if total_pages > 1:
                text = f"ğŸ“‹ **Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°** ({total_events} ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹, ÑÑ‚Ñ€. {page}/{total_pages})\n\n"
            else:
                text = f"ğŸ“‹ **Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°** ({total_events} ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹)\n\n"

            for i, event in enumerate(events, 1):
                # ĞĞ¾Ğ¼ĞµÑ€ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ (Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ offset)
                event_number = offset + i
                # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ
                date_str = event.starts_at.strftime("%d.%m.%Y %H:%M")

                # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ² ÑĞ¿Ğ¸ÑĞ¾Ğº (Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)
                safe_title = event.title.replace("*", "").replace("_", "").replace("`", "'")
                text += f"{event_number}. {safe_title}\n"
                text += f"   ğŸ“… {date_str}\n"

                # Ğ“Ğ¾Ñ€Ğ¾Ğ´ (Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ²Ğ²Ğ¾Ğ´, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ)
                city_to_show = None
                if event.city:
                    city_to_show = event.city
                elif event.location_url:
                    city_to_show = extract_city_from_location_url(event.location_url)

                if city_to_show:
                    safe_city = city_to_show.replace("*", "").replace("_", "").replace("`", "'")
                    text += f"   ğŸ™ï¸ {safe_city}\n"

                # ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
                if event.description:
                    desc = event.description[:80] + "..." if len(event.description) > 80 else event.description
                    safe_desc = desc.replace("*", "").replace("_", "").replace("`", "'")
                    text += f"   ğŸ“ {safe_desc}\n"

                # ĞœĞµÑÑ‚Ğ¾ Ñ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ñƒ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
                if event.location_name:
                    safe_location = event.location_name.replace("*", "").replace("_", "").replace("`", "'")
                    if event.location_url:
                        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ñƒ Ğ² Markdown Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ
                        safe_url = event.location_url.replace("(", "").replace(")", "")
                        text += f"   ğŸ“ [{safe_location}]({safe_url})\n"
                    else:
                        text += f"   ğŸ“ {safe_location}\n"
                elif event.location_url:
                    # Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑÑ‹Ğ»ĞºĞ°, Ğ±ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¼ĞµÑÑ‚Ğ°
                    safe_url = event.location_url.replace("(", "").replace(")", "")
                    text += f"   ğŸ“ [ĞœĞµÑÑ‚Ğ¾ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ğµ]({safe_url})\n"

                # ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€
                if event.organizer_username:
                    text += f"   ğŸ‘¤ ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€: @{event.organizer_username}\n"

                text += "\n"

            if is_admin:
                text += "ğŸ”§ ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ: Ğ’Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ»ÑĞ±Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ½Ğ¸Ğ¶Ğµ!\n"
                text += "ğŸ’¡ ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ğµ!"
            else:
                text += "ğŸ”§ Ğ’Ğ°ÑˆĞ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ: Ğ’Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ½Ğ¸Ğ¶Ğµ!\n"
                text += "ğŸ’¡ ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ğµ!"

        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸
        keyboard_buttons = []

        if events:
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ
            for i, event in enumerate(events, 1):
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
                can_delete_this_event = False

                # 1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
                if event.organizer_id == user_id:
                    can_delete_this_event = True
                # 2. ĞĞ´Ğ¼Ğ¸Ğ½ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ»ÑĞ±Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
                elif is_admin:
                    can_delete_this_event = True

                if can_delete_this_event:
                    # Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğµ Ğ¾Ğ±Ñ€ĞµĞ·Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
                    safe_title = event.title[:15] if len(event.title) > 15 else event.title
                    # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ğµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹
                    safe_title = safe_title.replace("\n", " ").replace("\r", " ").strip()

                    keyboard_buttons.append(
                        [
                            InlineKeyboardButton(
                                text=f"âŒ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ: {safe_title}",
                                callback_data=f"group_delete_event_{event.id}",
                            )
                        ]
                    )

        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°Ğ¼
        navigation_buttons = []
        if total_pages > 1:
            if page > 1:
                navigation_buttons.append(
                    InlineKeyboardButton(text="â—€ï¸ ĞŸÑ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ°Ñ", callback_data=f"group_list_page_{page - 1}")
                )
            if page < total_pages:
                navigation_buttons.append(
                    InlineKeyboardButton(text="â–¶ï¸ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ°Ñ", callback_data=f"group_list_page_{page + 1}")
                )
            if navigation_buttons:
                keyboard_buttons.append(navigation_buttons)

        # ĞšĞ½Ğ¾Ğ¿ĞºĞ° "ĞĞ°Ğ·Ğ°Ğ´"
        keyboard_buttons.append([InlineKeyboardButton(text="â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="group_back_to_panel")])

        back_kb = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)

        # Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸
        logger.info(
            f"ğŸ”¥ group_list_events: Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ğ¸Ğ½Ğ¾Ğ¹ {len(text)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ², {len(keyboard_buttons)} ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº"
        )
        if keyboard_buttons:
            for i, button_row in enumerate(keyboard_buttons):
                for j, button in enumerate(button_row):
                    logger.info(f"ğŸ”¥ ĞšĞ½Ğ¾Ğ¿ĞºĞ° {i},{j}: '{button.text}' -> '{button.callback_data}'")

        try:
            # ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ´Ğ»Ğ¸Ğ½Ñƒ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ´Ğ»Ñ Telegram
            if len(text) > 4000:
                text = text[:3900] + "\n\n... (Ñ‚ĞµĞºÑÑ‚ Ğ¾Ğ±Ñ€ĞµĞ·Ğ°Ğ½)"

            # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ğµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ°, Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Markdown ÑÑÑ‹Ğ»ĞºĞ¸
            import re
            import uuid

            # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ²ÑĞµ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¸Ñ… Ğ½Ğ° ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ñ‹
            link_pattern = r"\[([^\]]+)\]\(([^\)]+)\)"
            links_map = {}  # ĞœĞ°Ñ€ĞºĞµÑ€ -> (link_text, link_url)

            def replace_with_marker(match):
                link_text = match.group(1)
                link_url = match.group(2)
                # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ°Ñ€ĞºĞµÑ€ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ´Ñ‡ĞµÑ€ĞºĞ¸Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ñ… ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
                marker = f"LINKMARKER{uuid.uuid4().hex}"
                links_map[marker] = (link_text, link_url)
                return marker

            # Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ²ÑĞµ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° Ğ¼Ğ°Ñ€ĞºĞµÑ€Ñ‹
            text = re.sub(link_pattern, replace_with_marker, text)

            # Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ğµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ (Ğ¼Ğ°Ñ€ĞºĞµÑ€Ñ‹ Ğ½Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ Ğ¸Ñ…)
            text = text.replace("`", "'").replace("*", "").replace("_", "").replace("[", "(").replace("]", ")")

            # Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ¸Ğ· Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ¾Ğ²
            for marker, (link_text, link_url) in links_map.items():
                # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ¸ URL Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ñ… ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
                safe_text = link_text.replace("*", "").replace("_", " ").replace("[", "").replace("]", "")
                safe_url = link_url.replace("(", "%28").replace(")", "%29")
                text = text.replace(marker, f"[{safe_text}]({safe_url})")

            # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ Markdown Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ ÑÑÑ‹Ğ»Ğ¾Ğº
            await callback.message.edit_text(text, reply_markup=back_kb, parse_mode="Markdown")
            logger.info("âœ… Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")
        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e}")

            # Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ´Ğ»Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ "ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾"
            if "message is not modified" in str(e).lower():
                logger.info("ğŸ”¥ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒ, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ")
                try:
                    answer_kwargs = {"reply_markup": back_kb, "parse_mode": "Markdown"}
                    if is_forum and thread_id:
                        answer_kwargs["message_thread_id"] = thread_id
                    await callback.message.answer(text, **answer_kwargs)
                    logger.info("âœ… ĞĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑĞ¾ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾")
                except Exception as e2:
                    logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e2}")
                    await callback.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹", show_alert=True)
            else:
                # Fallback: Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Markdown
                try:
                    answer_kwargs = {"reply_markup": back_kb, "parse_mode": "Markdown"}
                    if is_forum and thread_id:
                        answer_kwargs["message_thread_id"] = thread_id
                    await callback.message.answer(text, **answer_kwargs)
                except Exception as e2:
                    logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e2}")
                    # ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ fallback: Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ±ĞµĞ· ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹
                try:
                    answer_kwargs = {
                        "text": "ğŸ“‹ **Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°**\n\nâŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.",
                        "parse_mode": "Markdown",
                    }
                    if is_forum and thread_id:
                        answer_kwargs["message_thread_id"] = thread_id
                    await callback.message.answer(**answer_kwargs)
                except Exception as e3:
                    logger.error(f"âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e3}")
                    await callback.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹", show_alert=True)
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹: {e}")
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        error_text = (
            "ğŸ“‹ **Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°**\n\n"
            "âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹.\n\n"
            "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ."
        )
        back_kb = InlineKeyboardMarkup(
            inline_keyboard=[
                [InlineKeyboardButton(text="â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="group_back_to_panel")],
            ]
        )
        try:
            await callback.message.edit_text(error_text, reply_markup=back_kb, parse_mode="Markdown")
        except Exception as edit_error:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ: {edit_error}")
            # Fallback: Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
            try:
                is_forum = getattr(callback.message.chat, "is_forum", False)
                thread_id = getattr(callback.message, "message_thread_id", None)
                answer_kwargs = {"reply_markup": back_kb, "parse_mode": "Markdown"}
                if is_forum and thread_id:
                    answer_kwargs["message_thread_id"] = thread_id
                await callback.message.answer(error_text, **answer_kwargs)
            except Exception as fallback_error:
                logger.error(f"âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ: {fallback_error}")


@group_router.callback_query(F.data == "group_back_to_panel")
async def group_back_to_panel(callback: CallbackQuery, bot: Bot, session: AsyncSession):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğº Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸"""
    chat_id = callback.message.chat.id
    logger.info(f"ğŸ”¥ group_back_to_panel: Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğº Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}")

    await callback.answer()

    try:
        await callback.message.edit_text(PANEL_TEXT, reply_markup=group_kb(chat_id), parse_mode="Markdown")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e}")


@group_router.callback_query(F.data == "group_hide_confirm")
async def group_hide_confirm(callback: CallbackQuery, bot: Bot, session: AsyncSession):
    """ĞŸĞ¾ĞºĞ°Ğ· Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° - Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ"""
    chat_id = callback.message.chat.id
    user_id = callback.from_user.id
    logger.info(f"ğŸ”¥ group_hide_confirm: Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ğ» Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}")

    await callback.answer("ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ...", show_alert=False)

    confirmation_text = (
        "ğŸ‘ï¸â€ğŸ—¨ï¸ **Ğ¡Ğ¿Ñ€ÑÑ‚Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°**\n\n"
        "Ğ’Ñ‹ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑĞºÑ€Ñ‹Ñ‚ÑŒ Ğ²ÑĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° Ğ¸Ğ· ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°?\n\n"
        "âš ï¸ **Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:**\n"
        "â€¢ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ Ğ²ÑĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° Ğ¸Ğ· Ñ‡Ğ°Ñ‚Ğ°\n"
        "â€¢ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹\n"
        "â€¢ Ğ‘Ğ¾Ñ‚ Ğ¾ÑÑ‚Ğ°Ğ½ĞµÑ‚ÑÑ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ, Ğ½Ğ¾ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°ÑĞ¾Ñ€ÑÑ‚ÑŒ Ñ‡Ğ°Ñ‚\n\n"
        "ğŸ’¡ **ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ** - Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´Ğ°ĞµÑ‚ Ñ‡Ğ°Ñ‚ Ğ¾Ñ‚ ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹\n\n"
        "Ğ”Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ Ğ±Ğ¾Ñ‚Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /start"
    )

    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="âœ… Ğ”Ğ°, ÑĞ¿Ñ€ÑÑ‚Ğ°Ñ‚ÑŒ", callback_data=f"group_hide_execute_{chat_id}")],
            [InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="group_back_to_panel")],
        ]
    )

    # Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
    try:
        await bot.edit_message_text(
            chat_id=chat_id,
            message_id=callback.message.message_id,
            text=confirmation_text,
            reply_markup=keyboard,
            parse_mode="Markdown",
        )
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸: {e}")
        # Fallback - Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· send_tracked
        from utils.messaging_utils import send_tracked

        try:
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ thread_id Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ¾Ğ²
            is_forum = getattr(callback.message.chat, "is_forum", False)
            thread_id = getattr(callback.message, "message_thread_id", None)

            send_kwargs = {"reply_markup": keyboard}
            if is_forum and thread_id:
                send_kwargs["message_thread_id"] = thread_id

            await send_tracked(
                bot,
                session,
                chat_id=chat_id,
                text=confirmation_text,
                tag="service",
                **send_kwargs,
            )
        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ: {e}")


@group_router.callback_query(F.data == "group_hide_execute")
async def group_hide_execute_direct(callback: CallbackQuery, bot: Bot, session: AsyncSession):
    """ĞŸÑ€ÑĞ¼Ğ¾Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° Ğ±ĞµĞ· Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ"""
    chat_id = callback.message.chat.id
    user_id = callback.from_user.id

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ thread_id Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ¾Ğ²
    is_forum = getattr(callback.message.chat, "is_forum", False)
    thread_id = getattr(callback.message, "message_thread_id", None)

    logger.info(
        f"ğŸ”¥ group_hide_execute_direct: Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}, thread_id={thread_id}"
    )

    await callback.answer("Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸ÑĞ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°â€¦", show_alert=False)

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ±Ğ¾Ñ‚Ğ° Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
    try:
        bot_member = await bot.get_chat_member(chat_id, bot.id)
        logger.info(
            f"ğŸ”¥ ĞŸÑ€Ğ°Ğ²Ğ° Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}: status={bot_member.status}, "
            f"can_delete_messages={getattr(bot_member, 'can_delete_messages', None)}"
        )

        if bot_member.status != "administrator" or not getattr(bot_member, "can_delete_messages", False):
            logger.warning(f"ğŸš« Ğ£ Ğ±Ğ¾Ñ‚Ğ° Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}")
            await callback.message.edit_text(
                "âŒ **ĞÑˆĞ¸Ğ±ĞºĞ°: ĞĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ**\n\n"
                "Ğ‘Ğ¾Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¾Ğ¼ 'Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹'.\n\n"
                "ĞŸĞ¾Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹:\n"
                "1. Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼\n"
                "2. Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¾ 'Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹'\n\n"
                "ĞŸĞ¾ÑĞ»Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.",
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(
                    inline_keyboard=[
                        [InlineKeyboardButton(text="â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´ Ğº Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸", callback_data="group_back_to_panel")]
                    ]
                ),
            )
            return
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ°Ğ² Ğ±Ğ¾Ñ‚Ğ°: {e}")

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ delete_all_tracked (Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ñ‚Ñ€ĞµĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ)
    try:
        deleted = await delete_all_tracked(bot, session, chat_id=chat_id)
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ñ€ĞµĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {e}")
        deleted = 0

    # ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğµ (Ğ½Ğµ Ñ‚Ñ€ĞµĞºĞ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ³Ğ¾Ğ½ÑÑ‚ÑŒÑÑ Ğ·Ğ° Ğ½Ğ¸Ğ¼)
    send_kwargs = {
        "text": f"ğŸ‘ï¸â€ğŸ—¨ï¸ **Ğ‘Ğ¾Ñ‚ ÑĞºÑ€Ñ‹Ñ‚**\n\n"
        f"âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ±Ğ¾Ñ‚Ğ°: {deleted}\n"
        f"âœ… ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ÑÑ\n"
        f"âœ… Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹\n\n"
        f"ğŸ’¡ **Ğ”Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ Ğ±Ğ¾Ñ‚Ğ°:**\n"
        f"Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /start",
        "parse_mode": "Markdown",
    }
    if is_forum and thread_id:
        send_kwargs["message_thread_id"] = thread_id
    note = await bot.send_message(chat_id, **send_kwargs)

    # Ğ’ĞĞ¡Ğ¡Ğ¢ĞĞĞĞ’Ğ›Ğ˜Ğ’ĞĞ•Ğœ ĞšĞĞœĞĞĞ”Ğ« ĞŸĞĞ¡Ğ›Ğ• Ğ¡ĞšĞ Ğ«Ğ¢Ğ˜Ğ¯ Ğ‘ĞĞ¢Ğ (ĞĞĞ”Ğ•Ğ–ĞĞ)
    await ensure_group_start_command(bot, chat_id)

    # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· 5 ÑĞµĞºÑƒĞ½Ğ´
    try:
        import asyncio

        await asyncio.sleep(5)
        await note.delete()
    except Exception:
        pass  # Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ

    logger.info(f"âœ… Ğ‘Ğ¾Ñ‚ ÑĞºÑ€Ñ‹Ñ‚ Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ {user_id}, ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {deleted}")


@group_router.callback_query(F.data.startswith("group_hide_execute_"))
async def group_hide_execute(callback: CallbackQuery, bot: Bot, session: AsyncSession):
    """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°"""
    chat_id = int(callback.data.split("_")[-1])
    user_id = callback.from_user.id

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ thread_id Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€ÑƒĞ¼Ğ¾Ğ²
    is_forum = getattr(callback.message.chat, "is_forum", False)
    thread_id = getattr(callback.message, "message_thread_id", None)

    logger.info(
        f"ğŸ”¥ group_hide_execute: Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ğ» ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}, thread_id={thread_id}"
    )

    await callback.answer("Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸ÑĞ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°â€¦", show_alert=False)

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ±Ğ¾Ñ‚Ğ° Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
    try:
        bot_member = await bot.get_chat_member(chat_id, bot.id)
        logger.info(
            f"ğŸ”¥ ĞŸÑ€Ğ°Ğ²Ğ° Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}: status={bot_member.status}, "
            f"can_delete_messages={getattr(bot_member, 'can_delete_messages', None)}"
        )

        if bot_member.status != "administrator" or not getattr(bot_member, "can_delete_messages", False):
            logger.warning(f"ğŸš« Ğ£ Ğ±Ğ¾Ñ‚Ğ° Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}")
            await callback.message.edit_text(
                "âŒ **ĞÑˆĞ¸Ğ±ĞºĞ°: ĞĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ**\n\n"
                "Ğ‘Ğ¾Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¾Ğ¼ 'Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹'.\n\n"
                "ĞŸĞ¾Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹:\n"
                "1. Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼\n"
                "2. Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¾ 'Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹'\n\n"
                "ĞŸĞ¾ÑĞ»Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.",
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(
                    inline_keyboard=[
                        [InlineKeyboardButton(text="â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´ Ğº Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸", callback_data="group_back_to_panel")]
                    ]
                ),
            )
            return
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ°Ğ² Ğ±Ğ¾Ñ‚Ğ°: {e}")

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ delete_all_tracked
    try:
        deleted = await delete_all_tracked(bot, session, chat_id=chat_id)
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {e}")
        deleted = 0

    # ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğµ (Ğ½Ğµ Ñ‚Ñ€ĞµĞºĞ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ³Ğ¾Ğ½ÑÑ‚ÑŒÑÑ Ğ·Ğ° Ğ½Ğ¸Ğ¼)
    send_kwargs = {
        "text": f"ğŸ‘ï¸â€ğŸ—¨ï¸ **Ğ‘Ğ¾Ñ‚ ÑĞºÑ€Ñ‹Ñ‚**\n\n"
        f"Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {deleted}\n"
        f"Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹.\n\n"
        f"Ğ”Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /start",
        "parse_mode": "Markdown",
    }
    if is_forum and thread_id:
        send_kwargs["message_thread_id"] = thread_id
    note = await bot.send_message(chat_id, **send_kwargs)

    # Ğ’ĞĞ¡Ğ¡Ğ¢ĞĞĞĞ’Ğ›Ğ˜Ğ’ĞĞ•Ğœ ĞšĞĞœĞĞĞ”Ğ« ĞŸĞĞ¡Ğ›Ğ• Ğ¡ĞšĞ Ğ«Ğ¢Ğ˜Ğ¯ Ğ‘ĞĞ¢Ğ (ĞĞĞ”Ğ•Ğ–ĞĞ)
    await ensure_group_start_command(bot, chat_id)

    # ĞĞ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· 8 ÑĞµĞºÑƒĞ½Ğ´
    try:
        await asyncio.sleep(8)
        await bot.delete_message(chat_id, note.message_id)
    except Exception as e:
        logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ: {e}")


@group_router.callback_query(F.data.startswith("group_delete_event_"))
async def group_delete_event(callback: CallbackQuery, bot: Bot, session: AsyncSession):
    """Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)"""
    chat_id = callback.message.chat.id
    user_id = callback.from_user.id

    # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ID ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¸Ğ· callback_data
    try:
        event_id = int(callback.data.split("_")[-1])
    except ValueError:
        await callback.answer("âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ID ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ", show_alert=True)
        return

    logger.info(f"ğŸ”¥ group_delete_event: Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ¿Ñ‹Ñ‚Ğ°ĞµÑ‚ÑÑ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ {event_id} Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}")

    try:
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ´Ğ»ĞµĞ¶Ğ¸Ñ‚ ÑÑ‚Ğ¾Ğ¼Ñƒ Ñ‡Ğ°Ñ‚Ñƒ
        from sqlalchemy import select

        stmt = select(CommunityEvent).where(CommunityEvent.id == event_id, CommunityEvent.chat_id == chat_id)

        result = await session.execute(stmt)
        event = result.scalar_one_or_none()

        if not event:
            await callback.answer("âŒ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾", show_alert=True)
            return

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ:
        # 1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
        # 2. ĞĞ´Ğ¼Ğ¸Ğ½ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ (Ğ¸Ğ· admin_ids) Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ»ÑĞ±Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
        # 3. LEGACY: Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ (Ğ¸Ğ· admin_id) Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ»ÑĞ±Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
        # 4. FALLBACK: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
        can_delete = False

        if event.organizer_id == user_id:
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
            can_delete = True
            logger.info(f"âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} - ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ {event_id}")
        else:
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ admin_ids (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´)
            if event.admin_ids:
                try:
                    import json

                    saved_admin_ids = json.loads(event.admin_ids)
                    if user_id in saved_admin_ids:
                        can_delete = True
                        logger.info(f"âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} - Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ (Ğ¸Ğ· admin_ids) Ğ´Ğ»Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ {event_id}")
                except (json.JSONDecodeError, TypeError):
                    logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°ÑĞ¿Ğ°Ñ€ÑĞ¸Ñ‚ÑŒ admin_ids: {event.admin_ids}")

            # LEGACY: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ admin_id (Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸)
            if not can_delete and event.admin_id == user_id:
                can_delete = True
                logger.info(f"âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} - Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ (LEGACY admin_id) Ğ´Ğ»Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ {event_id}")

            # FALLBACK: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
            if not can_delete and await is_chat_admin(bot, chat_id, user_id):
                can_delete = True
                logger.info(f"âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} - Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸)")

        if not can_delete:
            await callback.answer(
                "âŒ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ÑÑ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ!", show_alert=True
            )
            return

        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¼ĞµÑ‚Ğ¾Ğ´ CommunityEventsService Ğ´Ğ»Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        from utils.community_events_service import CommunityEventsService

        community_service = CommunityEventsService()
        deleted = community_service.delete_community_event(event_id, chat_id)

        if deleted:
            logger.info(f"âœ… Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ {event_id} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ¸ Ğ·Ğ°Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ² events_community_archive")
        else:
            logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ {event_id} (Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, ÑƒĞ¶Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾)")
            # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· ORM ĞºĞ°Ğº fallback
            try:
                await session.delete(event)
                await session.commit()
                logger.info(f"âœ… Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ {event_id} ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· fallback")
            except Exception as fallback_error:
                logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° fallback ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ: {fallback_error}")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ: {e}")
        await callback.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ", show_alert=True)
        return

    await callback.answer("âœ… Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾!", show_alert=False)
    logger.info(f"ğŸ”¥ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ {event_id}")

    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
    await group_list_events(callback, bot, session)


# === Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ ===


def format_event_short(event: CommunityEvent) -> str:
    """ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ°"""
    date_str = event.starts_at.strftime("%d.%m %H:%M")
    text = f"**{event.title}**\nğŸ“… {date_str}"

    # Ğ“Ğ¾Ñ€Ğ¾Ğ´ (Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ²Ğ²Ğ¾Ğ´, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ)
    city_to_show = None
    if event.city:
        city_to_show = event.city
    elif event.location_url:
        city_to_show = extract_city_from_location_url(event.location_url)

    if city_to_show:
        text += f"\nğŸ™ï¸ {city_to_show}"

    if event.location_name:
        text += f"\nğŸ“ {event.location_name}"

    return text
