# –û—Ç—á–µ—Ç: OAuth –º–æ–∫-—Ä–µ–∂–∏–º + –Ω–∞–¥—ë–∂–Ω—ã–π DATABASE_URL

## –°—Ç–∞—Ç—É—Å: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

### –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

1. **–û–±–Ω–æ–≤–ª–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π OAuth –∫–æ–ª–±—ç–∫** (`api/app.py`)
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–µ—Ç–∫–∞ –º–æ–∫-—Ä–µ–∂–∏–º–∞ –≤ –Ω–∞—á–∞–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –ª–æ–≥–∏–∫–∞ –æ–±–º–µ–Ω–∞ —Ç–æ–∫–µ–Ω–æ–≤
   - –ï–¥–∏–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤

2. **–£–ª—É—á—à–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è** (`config.py`)
   - –ó–∞–≥—Ä—É–∑–∫–∞ `.env.local` –∏ `.env` —Ñ–∞–π–ª–æ–≤
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç `.env.local` –Ω–∞–¥ `.env`
   - –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å `override=False`

3. **–õ–µ–Ω–∏–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ engine** (`api/app.py`)
   - –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `_engine`
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ –ø–µ—Ä–≤–æ–º—É –≤—ã–∑–æ–≤—É
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `load_settings()` –∏–∑ config

4. **–°–æ–∑–¥–∞–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã** (`tests/test_oauth_meetup_mock.py`)
   - –¢–µ—Å—Ç—ã –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `monkeypatch` –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ `pytest.mark.api` –¥–ª—è –ª–µ–≥–∫–æ–≥–æ CI

5. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** (`README.md`)
   - –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –º–æ–∫-—Ä–µ–∂–∏–º—É
   - Redirect URL –¥–ª—è Meetup
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

6. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VS Code** (`.vscode/launch.json`)
   - –ó–∞–ø—É—Å–∫ —Å `.env.local`
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –º–æ–∫-—Ä–µ–∂–∏–º–∞

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### –í `api/app.py` (—Å—Ç—Ä–æ–∫–∏ 37-65):
```python
@oauth_router.get("/callback")
async def meetup_callback(
    code: str | None = Query(default=None, description="Authorization code"),
    state: str | None = Query(default=None),
    error: str | None = Query(default=None),
):
    """
    OAuth –∫–æ–ª–±—ç–∫ –¥–ª—è Meetup: –æ–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã –∏–ª–∏ –º–æ–∫-—Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    """
    # –µ–¥–∏–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    if error:
        raise HTTPException(status_code=400, detail=f"Meetup error: {error}")
    if not code:
        raise HTTPException(status_code=400, detail="Missing code")

    # üîπ –º–æ–∫-—Ä–µ–∂–∏–º –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤
    if os.getenv("MEETUP_MOCK") == "1":
        return {"ok": True, "code": code, "state": state, "mock": True}

    # üîπ –±–æ–µ–≤–æ–π –ø—É—Ç—å (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
    try:
        mgr = MeetupOAuth()
        bundle = await mgr.exchange_code(code)
        # ... –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç —Ç–æ–∫–µ–Ω–æ–≤
    except Exception as e:
        logger.error("–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞ –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã: %s", e)
        raise HTTPException(status_code=500, detail=f"Failed to exchange code: {str(e)}")
```

#### –í `config.py`:
```python
# Load .env.local and .env files (first .env.local, then .env)
_BASE_DIR = Path(__file__).resolve().parent
for fn in (".env.local", ".env"):
    env_file = _BASE_DIR / fn
    if env_file.exists():
        load_dotenv(env_file, override=False, encoding="utf-8-sig")
```

#### –í `api/app.py` (–ª–µ–Ω–∏–≤—ã–π engine):
```python
_engine: Engine | None = None

def get_engine() -> Engine:
    """–°–æ–∑–¥–∞—ë—Ç Engine –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ –ø–µ—Ä–≤–æ–º—É –≤—ã–∑–æ–≤—É, –±–µ—Ä—è —Å—Ç—Ä–æ–∫—É –∏–∑ config."""
    global _engine
    if _engine is None:
        from config import load_settings
        settings = load_settings()
        if not settings.database_url:
            raise RuntimeError("DATABASE_URL is not set")
        _engine = create_engine(settings.database_url, future=True, pool_pre_ping=True)
    return _engine
```

### Acceptance Criteria - –ü—Ä–æ–≤–µ—Ä–∫–∞

#### ‚úÖ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç GET /oauth/meetup/callback:
- **error ‚Üí 400**: ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ
- **–±–µ–∑ code ‚Üí 400**: ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ  
- **–ø—Ä–∏ MEETUP_MOCK=1 ‚Üí {"ok": true, "code": "...", "state": "...", "mock": true}**: ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ
- **–±–µ–∑ MEETUP_MOCK –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±–º–µ–Ω code‚Üítokens**: ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –ª–æ–≥–∏–∫–∞

#### ‚úÖ .env.local –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è:
- –ó–∞–≥—Ä—É–∑–∫–∞ `.env.local` –∏ `.env` —Ñ–∞–π–ª–æ–≤
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç `.env.local` –Ω–∞–¥ `.env`
- `DATABASE_URL` –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ `load_settings()`

#### ‚úÖ Engine —Å–æ–∑–¥–∞—ë—Ç—Å—è –ª–µ–Ω–∏–≤–æ:
- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `_engine`
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ –ø–µ—Ä–≤–æ–º—É –≤—ã–∑–æ–≤—É
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ config

#### ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è –º–æ–∫-–≤–µ—Ç–∫–∏:
- –°–æ–∑–¥–∞–Ω—ã `tests/test_oauth_meetup_mock.py`
- –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ `pytest.mark.api`
- –†–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

#### ‚úÖ README —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é:
- –†–∞–∑–¥–µ–ª "Meetup OAuth ‚Äî –º–æ–∫-—Ä–µ–∂–∏–º (dev)"
- Redirect URL: `http://localhost:8000/oauth/meetup/callback`
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
```bash
# –ú–æ–∫-—Ä–µ–∂–∏–º
export MEETUP_MOCK=1
uvicorn api.app:app --reload --port 8000
curl "http://localhost:8000/oauth/meetup/callback?code=test123&state=xyz"
# –û—Ç–≤–µ—Ç: {"ok":true,"code":"test123","state":"xyz","mock":true}

# –û—à–∏–±–∫–∞ –±–µ–∑ –∫–æ–¥–∞
curl "http://localhost:8000/oauth/meetup/callback"
# –û—Ç–≤–µ—Ç: {"detail":"Missing code"} (400)
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã:
```bash
export FULL_TESTS=1
pytest -q -m "api -k oauth_meetup_mock"
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é:**

1. **–ú–æ–∫-—Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω** - –≤–µ—Ç–∫–∞ `MEETUP_MOCK=1` –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–ª–±—ç–∫–µ
2. **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞** - –æ–±–º–µ–Ω —Ç–æ–∫–µ–Ω–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ
3. **–ù–∞–¥—ë–∂–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ .env** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `.env.local` –∏ `.env`
4. **–õ–µ–Ω–∏–≤—ã–π engine** - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ –ø–µ—Ä–≤–æ–º—É –≤—ã–∑–æ–≤—É
5. **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã** - –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
6. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –º–æ–∫-—Ä–µ–∂–∏–º—É
7. **VS Code –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - —É–¥–æ–±–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å .env.local

–ö–æ–ª–±—ç–∫ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∫–∞–∫ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–º–æ–∫-—Ä–µ–∂–∏–º), —Ç–∞–∫ –∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (–±–æ–µ–≤–æ–π —Ä–µ–∂–∏–º).
