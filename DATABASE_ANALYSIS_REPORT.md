# 🗄️ Анализ базы данных EventBot

**Дата анализа:** 14 октября 2025  
**База данных:** PostgreSQL (Railway)  
**Версия проекта:** 1.0.0

---

## 📊 Общая статистика

### Таблицы в базе данных: **12**

| Таблица | Записей | Размер | Назначение |
|---------|---------|--------|------------|
| **events** | 51 | 288 KB | Основная таблица всех событий |
| **users** | 7 | 64 KB | Пользователи Telegram бота |
| **tasks** | 30 | 64 KB | Задания для геймификации |
| **user_tasks** | 20 | 64 KB | Выполненные пользователями задания |
| **events_community** | 5 | 96 KB | Групповые события в чатах |
| **bot_messages** | 21 | 120 KB | Сообщения бота для функции "Спрятать бота" |
| **user_participation** | 0 | 120 KB | Участие пользователей в событиях |
| **chat_settings** | 1 | 24 KB | Настройки групповых чатов |
| **reports** | 0 | 16 KB | Репорты от пользователей |
| **task_places** | 0 | 16 KB | Места для заданий |
| **task_templates** | 0 | 16 KB | Шаблоны заданий |
| **daily_views** | 0 | 8 KB | Просмотры контента |

**Общий размер базы данных:** ~960 KB

---

## 🎯 Таблица EVENTS (основная)

### Статистика по источникам

```
📌 KudaGo:      36 событий (70.6%)
📌 BaliForum:   12 событий (23.5%)
📌 User:         3 события (5.9%)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Всего:          51 событие
```

### Статистика по статусам

```
✅ open:    33 события (64.7%)
❌ closed:  18 событий (35.3%)
```

### Географическое покрытие

**Топ-3 города:**
1. 🏙️ **Москва** — 21 событие (41.2%)
2. 🏙️ **Санкт-Петербург** — 15 событий (29.4%)
3. 🏝️ **Бали** — 15 событий (29.4%)

### Качество данных

| Поле | Заполненность | Статус |
|------|---------------|--------|
| Координаты (lat/lng) | 98.0% | ✅ Отлично |
| Дата начала (starts_at) | 94.1% | ✅ Отлично |
| Дата окончания (ends_at) | 3.9% | ⚠️ Низкая |
| Geo hash | 45.1% | ⚠️ Средняя |
| Нормализованная дата | 41.2% | ⚠️ Средняя |

### Временная статистика

- **Будущие события:** 7 (13.7%)
- **Прошедшие события:** 41 (80.4%)
- **Без даты:** 3 (5.9%)

> ⚠️ **Рекомендация:** Настроить автоматическую очистку прошедших событий

---

## 👥 Таблица USERS

### Статистика

```
Всего пользователей:           7
С геолокацией:                 5 (71.4%)
С часовым поясом:              0 (0%)
Общий баланс ракет:            175 🚀
```

### Качество данных

| Поле | Заполненность | Статус |
|------|---------------|--------|
| Username | 100% | ✅ Отлично |
| Последняя геолокация | 71.4% | ✅ Хорошо |
| Часовой пояс | 0% | ❌ Критично |

> ⚠️ **Критичная проблема:** Ни у одного пользователя не установлен часовой пояс!

---

## 📋 Система заданий (Gamification)

### Задания

```
Всего заданий:                 30
├─ Body:                       15 (50%)
└─ Spirit:                     15 (50%)
```

### Пользовательские задания

```
Всего принятых заданий:        20
├─ Завершено:                   7 (35%)
└─ Истекло:                    13 (65%)
```

> 💡 **Insight:** Высокий процент истекших заданий (65%) — возможно, слишком короткий срок выполнения

---

## 🏘️ Групповые события

```
Всего групповых событий:       5
Все в статусе:                 open (100%)
Активных чатов:                1
```

---

## 🔑 Индексы и оптимизация

### Таблица EVENTS (11 индексов)

**Основные индексы:**
- ✅ `unique_source_external_id` — дедупликация по источнику
- ✅ `ix_events_starts_at` — сортировка по времени
- ✅ `ix_events_source` — фильтрация по источнику
- ✅ `idx_events_geo_hash` — геопоиск
- ✅ `idx_events_chat_id` — поиск по чату

**Composite индексы:**
- ✅ `ix_events_source_ext` — (source, external_id)

### Проверка дубликатов

```
✅ Дубликатов не найдено
```

---

## 🔗 Связи между таблицами (Foreign Keys)

```
┌─────────────────┐
│     users       │
│   (id: BIGINT)  │
└────────┬────────┘
         │
         ├──────────► daily_views.user_id
         │
         │
┌────────▼────────┐
│     events      │
│   (id: INT)     │
└────────┬────────┘
         │
         └──────────► user_participation.event_id
         
┌─────────────────┐
│     tasks       │
│   (id: INT)     │
└────────┬────────┘
         │
         └──────────► user_tasks.task_id
```

---

## 📐 ER-диаграмма (упрощенная)

```
┌──────────────────────────────────────────────────────────────┐
│                     ОСНОВНЫЕ ТАБЛИЦЫ                          │
└──────────────────────────────────────────────────────────────┘

┌────────────────┐        ┌────────────────┐
│     USERS      │◄───────│    EVENTS      │
│────────────────│        │────────────────│
│ • id (PK)      │        │ • id (PK)      │
│ • username     │        │ • source       │
│ • full_name    │        │ • external_id  │
│ • last_lat     │        │ • title        │
│ • last_lng     │        │ • starts_at    │
│ • rockets_bal  │        │ • lat, lng     │
└────────┬───────┘        │ • organizer_id │
         │                └────────┬───────┘
         │                         │
         │                ┌────────▼───────┐
         │                │ EVENTS_COMM    │
         │                │────────────────│
         │                │ • id (PK)      │
         │                │ • chat_id      │
         │                │ • organizer_id │
         │                └────────────────┘
         │
┌────────▼───────┐        ┌────────────────┐
│     TASKS      │        │  USER_TASKS    │
│────────────────│        │────────────────│
│ • id (PK)      │◄───────│ • id (PK)      │
│ • category     │        │ • user_id      │
│ • title        │        │ • task_id (FK) │
│ • description  │        │ • status       │
└────────────────┘        └────────────────┘
```

---

## 🔍 Структура таблицы EVENTS

### Основные группы полей

**1. Идентификация**
```sql
id              INTEGER PRIMARY KEY
source          VARCHAR(64)     -- kudago, baliforum, user
external_id     VARCHAR(64)     -- ID из внешнего источника
dedupe_key      VARCHAR(64)     -- Ключ дедупликации
```

**2. Основная информация**
```sql
title           VARCHAR(255) NOT NULL
description     TEXT
status          VARCHAR(16) DEFAULT 'open'
```

**3. Временные метки**
```sql
starts_at               TIMESTAMP WITH TIME ZONE
ends_at                 TIMESTAMP WITH TIME ZONE
starts_at_normalized    TIMESTAMP WITH TIME ZONE  -- Нормализованное время
time_local              VARCHAR(16)                -- Legacy
time_utc                TIMESTAMP WITH TIME ZONE   -- Legacy
event_tz                VARCHAR(64)
```

**4. Геолокация**
```sql
lat             DOUBLE PRECISION
lng             DOUBLE PRECISION
geo_hash        VARCHAR(32)        -- Хеш координат для дедупликации
country         VARCHAR(10)
city            VARCHAR(64)
```

**5. Место проведения**
```sql
location_name   VARCHAR(255)
location_url    TEXT
venue_name      VARCHAR(255)
address         TEXT
```

**6. Организатор и участники**
```sql
organizer_id        BIGINT FK → users(id)
organizer_username  VARCHAR(255)
max_participants    INTEGER
current_participants INTEGER DEFAULT 0
participants_ids    TEXT            -- CSV список ID
```

**7. Группы и сообщества**
```sql
chat_id         BIGINT
community_name  VARCHAR(120)
community_link  TEXT
```

**8. Метаданные**
```sql
url                 TEXT
is_generated_by_ai  BOOLEAN DEFAULT false
created_at_utc      TIMESTAMP WITH TIME ZONE DEFAULT now()
updated_at_utc      TIMESTAMP WITH TIME ZONE DEFAULT now()
```

---

## ⚙️ Миграции

### Выполненные миграции

1. ✅ **merge_events_tables_production.sql** — Объединение `events_parser` и `events_user` в единую таблицу
2. ✅ **add_tasks_tables.sql** — Добавление системы заданий
3. ✅ **002_add_bot_tracking.sql** — Трекинг сообщений бота
4. ✅ **001_fix_events_community.sql** — Исправление групповых событий

### История миграции (2025-01-07)

```
БЫЛО:
├── events_parser   (51 записей)
├── events_user     (22 записи)
└── events_community (изолировано)

СТАЛО:
├── events          (73 записи) ← объединено
└── events_community (изолировано)

РЕЗУЛЬТАТ:
✅ 73 события успешно мигрированы
✅ 5 новых индексов для производительности
✅ 100% покрытие нормализованными полями
✅ 0 дубликатов
```

---

## 🎨 Примеры данных

### Событие из KudaGo
```json
{
  "id": 15337,
  "source": "kudago",
  "title": "инсталляция U-space «Вишнёвый сад»",
  "starts_at": "2025-10-13 09:00",
  "location_name": "Музей современного искусства Эрарта",
  "city": "spb",
  "lat": 59.93178799999995,
  "lng": 30.251674,
  "status": "open"
}
```

### Событие из BaliForum
```json
{
  "id": 2844,
  "source": "baliforum",
  "title": "Bitcoin Meetup Canggu",
  "starts_at": "2025-10-14 08:30",
  "city": "bali",
  "lat": -8.6432247,
  "lng": 115.1428191,
  "status": "open"
}
```

### Пользовательское событие
```json
{
  "id": 25,
  "source": "user",
  "title": "Прогулка под луной",
  "location_name": "Пляж Санур",
  "city": "bali",
  "lat": -8.5069,
  "lng": 115.2625,
  "status": "closed",
  "organizer_id": 456065084
}
```

---

## ✅ Сильные стороны

1. **Унифицированная архитектура** — единая таблица для всех событий
2. **Качественная индексация** — 11 индексов на таблице events
3. **Дедупликация** — уникальные индексы по (source, external_id)
4. **Геопоиск оптимизирован** — geo_hash для быстрого поиска
5. **Нет дубликатов** — проверка прошла успешно ✅
6. **Хорошая нормализация** — отдельные таблицы для заданий и групп

---

## ⚠️ Проблемы и рекомендации

### 🔴 Критичные

1. **Отсутствие часовых поясов у пользователей**
   - Ни у одного пользователя не заполнено поле `user_tz`
   - **Решение:** Добавить автоопределение TZ при регистрации

2. **80% прошедших событий**
   - 41 из 51 события уже прошло
   - **Решение:** Настроить автоочистку старых событий (cron job)

### 🟡 Средние

3. **Низкая заполненность нормализованных полей**
   - `starts_at_normalized`: 41.2%
   - `geo_hash`: 45.1%
   - **Решение:** Запустить скрипт нормализации для существующих данных

4. **Отсутствие `ends_at` у событий**
   - Только 2 из 51 события имеют дату окончания
   - **Решение:** Улучшить парсеры для извлечения времени окончания

5. **Высокий процент истекших заданий (65%)**
   - 13 из 20 заданий истекло без выполнения
   - **Решение:** Увеличить TTL заданий или упростить условия

### 🟢 Незначительные

6. **Legacy поля**
   - `time_local`, `time_utc` можно удалить (используется `starts_at`)
   - **Решение:** Создать миграцию для удаления после проверки

7. **CSV хранение ID участников**
   - `participants_ids` хранится как TEXT
   - **Решение:** Рассмотреть JSONB или отдельную таблицу

---

## 📈 Метрики производительности

### Размер индексов

| Индекс | Размер |
|--------|--------|
| unique_source_external_id | ~24 KB |
| ix_events_starts_at | ~16 KB |
| idx_events_geo_hash | ~12 KB |

### Статистика запросов (рекомендуемая)

**Наиболее частые запросы:**
1. Поиск событий по координатам + радиус (геопоиск)
2. Фильтрация по источнику
3. Сортировка по дате начала
4. Проверка дубликатов по (source, external_id)

**Все запросы покрыты индексами** ✅

---

## 🚀 Рекомендации по оптимизации

### Краткосрочные (1-2 недели)

1. ✅ Запустить нормализацию `geo_hash` и `starts_at_normalized` для всех событий
2. ✅ Настроить автоочистку прошедших событий (старше 7 дней)
3. ✅ Добавить автоопределение часового пояса при регистрации пользователя
4. ✅ Улучшить парсеры для извлечения `ends_at`

### Среднесрочные (1-2 месяца)

5. ⚙️ Добавить партиционирование таблицы `events` по датам (при > 10K записей)
6. ⚙️ Настроить VACUUM и ANALYZE через cron
7. ⚙️ Добавить мониторинг размера базы данных
8. ⚙️ Создать материализованное представление для популярных запросов

### Долгосрочные (3-6 месяцев)

9. 📊 Рассмотреть переход на PostGIS для геопоиска (если будет > 100K событий)
10. 📊 Добавить полнотекстовый поиск (pg_trgm или ElasticSearch)
11. 📊 Настроить репликацию для отказоустойчивости
12. 📊 Архивирование старых событий в отдельную таблицу

---

## 📊 SQL для проверки целостности

```sql
-- Проверка дубликатов
SELECT source, external_id, COUNT(*) 
FROM events 
WHERE source IS NOT NULL AND external_id IS NOT NULL
GROUP BY source, external_id 
HAVING COUNT(*) > 1;

-- Проверка NULL координат
SELECT COUNT(*) FROM events WHERE lat IS NULL OR lng IS NULL;

-- Проверка событий без даты
SELECT COUNT(*) FROM events WHERE starts_at IS NULL;

-- Топ источников
SELECT source, COUNT(*) as cnt 
FROM events 
GROUP BY source 
ORDER BY cnt DESC;

-- Будущие vs прошедшие
SELECT 
  COUNT(CASE WHEN starts_at > NOW() THEN 1 END) as future,
  COUNT(CASE WHEN starts_at <= NOW() THEN 1 END) as past
FROM events;
```

---

## 🎯 Итоговая оценка базы данных

| Критерий | Оценка | Комментарий |
|----------|--------|-------------|
| **Структура** | ⭐⭐⭐⭐⭐ | Отлично — чистая, нормализованная |
| **Индексация** | ⭐⭐⭐⭐⭐ | Отлично — покрыты все запросы |
| **Целостность** | ⭐⭐⭐⭐☆ | Хорошо — нет дубликатов, есть FK |
| **Качество данных** | ⭐⭐⭐☆☆ | Средне — много NULL, 80% старых событий |
| **Производительность** | ⭐⭐⭐⭐☆ | Хорошо — есть индексы, но нет партиций |
| **Масштабируемость** | ⭐⭐⭐⭐☆ | Хорошо — готова к росту до 100K событий |

### 🏆 Общая оценка: **4.2 / 5.0**

---

## 📝 Выводы

База данных EventBot находится в **хорошем состоянии** с качественной архитектурой и оптимизацией. Основные проблемы связаны с **качеством данных** (отсутствие часовых поясов, много старых событий), а не со структурой.

**Приоритетные действия:**
1. Настроить автоочистку прошедших событий
2. Добавить автоопределение часового пояса
3. Запустить нормализацию для существующих данных

База готова к продакшену и может масштабироваться до 100K+ событий без серьезных изменений архитектуры.

---

**Дата создания отчета:** 14 октября 2025  
**Автор:** AI Assistant (Claude)  
**Версия:** 1.0

